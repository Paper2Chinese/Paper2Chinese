# 题目：[Generalized Characteristic Function Loss for Crowd Analysis in the Frequency Domain](https://ieeexplore.ieee.org/document/10328449)  
## 人群分析的频域广义特征函数损失
**作者：Weibo Shu; Jia Wan; Antoni B. Chan** 

**源码链接：** https://github.com/wbshu/Crowd_Counting_in_the_Frequency_Domain
****

# 摘要

传统的学习方法在提取人群密度图中的监督信息时存在局限性，这些信息通常松散地组织在人群点/密度图中的空间信息中。本文通过在频域内进行监督来应对这一挑战。更具体地说，我们设计了一种新的用于人群分析的损失函数，称为广义特征函数损失（Generalized Characteristic Function Loss，GCFL）。这个损失函数执行两个步骤：1）将密度或点图中的空间信息转换到频域；2）计算它们频域内容之间的损失值。对于第一步，我们通过扩展概率分布的特征函数定义到密度图，并证明扩展特征函数的一些关键性质，从而建立了理论基础。在对密度图取特征函数后，其在频域中的信息被良好地组织和层次化分布，而在空间域中则是松散组织和分散的。在第二步中，我们设计了一个损失函数，可以适应频域中的信息组织，允许利用组织良好的频域信息来监督人群分析任务。该损失函数可以通过指定其窗口函数来适应各种人群分析任务。在本文中，我们通过理论分析和在基准数据集上的实验结果，展示了我们的GCFL与其他SOTA损失函数相比的优势，以及与其他SOTA方法的竞争性。我们的代码可在 https://github.com/wbshu/Crowd_Counting_in_the_Frequency_Domain 上获得。

# 关键词

- 人群分析 (Crowd analysis)
- 频域分析 (frequency domain analysis)
- 热图 (heatmaps)
- 损失函数 (loss function)
- 场景理解 (scene understanding)

# I. 引言

人群分析在实际应用中有着广泛的应用，例如监控、商业、城市规划和交通管理。在人群分析任务中，人群计数因其技术可应用于其他领域而受到极大关注，例如出于生态目的统计动物数量[1]、[2]、[3]，在显微镜图像中计数微生物[4]、[5]、[6]、[7]，以及在交通拥堵中计数车辆[8]、[9]、[10]、[11]。人群计数任务因人们头部和身体的遮挡和重叠以及人头形状和大小的剧烈变化而变得具有挑战性。尽管已经提出了许多杰出的工作来解决这一挑战[12]、[13]、[14]、[15]、[16]、[17]、[18]、[19]、[20]、[21]、[22]、[23]、[24]、[25]、[26]，但仍有许多空间可以进一步改进。此外，主流方法的训练依赖于点图，即图像中所有人头的手动注释。但在实际应用中，这张点图可能是有噪声的，例如，如果注释者工作很快或不够细心，注释可能会从确切的人头位置偏离到一定程度。如何使用带有噪声的点图进行人群计数是一个有实际需求但尚未充分探索的研究领域。最近，研究人员[25]、[26]、[27]、[28]、[29]也关注了人群定位，这是一个比人群计数更具挑战性的任务。对于一些高级人群分析任务，如行为检测、活动识别和人群跟踪，需要确切的人头或人的位置信息。基于这些任务在现实世界中的广泛应用，人群分析研究已经繁荣了多年，并从积极研究中受益。

自从[5]提出了人群密度图作为中间表示的想法以来，人群计数进入了点图监督时代。多列神经网络（MCNN）[30]是第一个使用密度图进行监督的深度神经网络（DNN），随后有许多模型跟进。随后的研究可以分为两类：1）设计网络结构以增加学习能力；2）研究如何更好地使用真实点图（Ground-Truth，GT）提供更强的监督。本文属于第二类，旨在设计损失以从GT中提取高质量的监督信息。

尽管第二类中已经有一些方法[24]、[25]、[26]获得了出色的性能，但它们也有一些缺点。首先，尽管在最优传输（Optimal Transport，OT）损失[24]、[25]和纯点基框架（Purely Point-Based Framework，P2PNet）[26]中对位置信息进行了充分的利用，但GT计数信息却被低估了。为此，它们引入了需要精细平衡或更多先验信息的额外项。其次，在每次训练步骤中，P2PNet[26]和OT损失[24]、[25]都依赖于迭代外部算法来从GT中提取空间信息。

我们认为上述缺点是由于空间域中信息分布的特性所导致的。首先，空间域中的计数信息和位置信息松散耦合，这使得最先进的方法（State-of-the-Art，SOTA）必须在充分利用位置信息的同时引入补救措施来利用计数信息；其次，空间域中的位置信息无处不在，因此需要一个全局优化程序来提取空间关系（例如，P2PNet的匈牙利算法[31]，OT损失的Sinkhorn算法[32]）。这些固有的缺点在空间域中很难改进——相反，我们考虑将信息转换到频域。通过将点图和密度图视为有限测度（即未归一化的概率密度），并将特征函数的定义从概率扩展到有限测度，我们可以通过派生点/密度图的特征函数，在频域中良好地组织信息。

在频域中，原始的空间信息被层次化地组织在一个紧凑的范围内围绕原点。靠近原点的信息包含全局空间信息（即哪些区域包含人群），而远离原点的信息与局部位置信息相关（即人的确切位置）。此外，我们的统计分析还表明，规则的空间注释噪声在频域中变为集中在环带中的噪声分布。因此，利用组织良好的频率信息可以帮助设计特定损失函数，更好地利用GT信息对不同人群分析任务进行训练。

在本文中，我们设计了一种广义特征函数损失（GCFL），用于将空间信息转换到频域，然后利用它来监督不同的人群分析任务。GCFL的灵活性体现在其窗口函数中，我们展示了如何通过应用不同的窗口函数使用GCFL处理人群计数、人群定位和嘈杂人群分析任务。在这个过程中，提供了坚实的理论和实验证据。图1显示了我们方法的基本框架。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/2649096deb8f432fa59e9a0f4ba2d10a.png#pic_ center" width="70%" />
</div>

总之，本文的贡献是：

- 我们通过将特征函数的定义从概率分布扩展到有限测度，建立了将空间人群信息转换到频域的理论基础，并证明或加强了一些关键性质。
- 特征函数转换产生了紧凑且层次化组织的频率信息，从中我们提出了广义特征函数损失（GCFL）用于人群分析任务。GCFL中的窗口函数可以定制，为特定人群分析任务提供灵活性。
- 我们展示了三个应用，使用不同的窗口函数：人群计数、人群定位和嘈杂人群计数。对于人群计数（见图1(b)），我们证明了最小化损失将减少预测和真实密度图之间的伪上确界范数度量（over all sub-regions）的上界，这对于人群计数是有效的。对于人群定位（图1(d)），我们利用频域中信息组织的优越性通过缩放预测/GT图来提高定位性能。对于嘈杂人群计数（见图1(c)），我们使用理论和统计分析揭示了空间域中的噪声注释在频域中将转换为规则环带中的噪声。然后我们设计了一个窗口函数来忽略这个规则环带，使损失对噪声注释具有鲁棒性。
- 据我们所知，这是第一项在频域内研究人群分析的工作。在基准数据集上的实验结果表明，我们的损失函数在人群计数、人群定位和嘈杂人群计数方面优于其他SOTA损失。

本文是我们初步工作[33]关于特征函数损失（ChfL）的扩展。在本文中，我们提出了一个广义损失函数GCFL（第III-B节），其中原始的ChfL损失[33]是特定窗口函数集的特殊情况。此外，我们通过为人群定位（第III-D节和第V-C节）和嘈杂人群计数（第III-E节和第V-D节）设计特定的窗口函数，将我们的GCFL应用于两个新任务，这些内容并未包含在我们初步的会议论文中。对于人群定位，我们提出了利用频域中信息分布的图缩放方法。对于嘈杂人群计数，我们推导了空间注释噪声在频域中的分布，并相应地设计了窗口函数以忽略这种噪声。与会议版本相比，我们还通过分析其梯度（第IV-B节）改进了GCFL的实现细节。新的实现方式导致更稳定的训练，对于重复训练运行的结果方差更低，更适合在实际应用中使用。此外，加强了一个性质（第III-A2节性质4），并包含了更多的消融研究（第V-B节）。最后，我们提供了更多的理论分析和实验结果，以表明对于我们的GCFL来说，低通滤波窗口并非必要（第IV-A2节），这解决了我们会议论文中的一个限制。

本文的其余部分组织如下。第II节介绍了人群分析的相关工作。第III节提出了GCFL并演示了其在人群计数、人群定位和嘈杂人群计数中的应用。第IV节是关于GCFL的实现。最后，第V节展示了我们的实验结果，第VI节总结了。

# III. 广义特征函数损失

在本节中，我们将介绍我们用于人群分析的频域损失框架。首先，在第III-A节中，我们围绕特征函数的定义和性质的扩展建立了我们框架的理论基础，通过这些我们可以将无组织的时空人群信息转换为层次化的频域信息。
其次，基于上述基础，在第III-B节中，我们提出了我们的广义特征函数损失（GCFL），其中基本的特征函数损失（ChfL）[33]是[33]中特定窗口函数集的一个特例。GCFL引入了一组窗口函数，允许损失针对特定的人群分析任务进行定制。框架在图1(a)中进行了总结。
第三，我们展示了如何使用GCFL进行三个人群分析任务。在第III-C节中，我们介绍了用于人群计数的GCFL（图1(b)），并证明了最小化GCFL将减少预测和真实密度图（在所有子区域上）之间的伪sup范数度量的上界。在第III-D节中，我们研究了用于人群定位的GCFL（图1(d)），在那里我们利用频域中的信息组织来通过缩放注释图来提高性能。最后，在第III-E节中，我们研究了用于嘈杂人群计数的GCFL，其中点注释包含空间噪声。通过理论和统计分析，我们首先展示了空间域中的不规则注释噪声将在频域中变成一个环形带中的规则噪声分布。然后我们设计了一组窗口函数（图1(c)），这些窗口函数对这种频域噪声具有鲁棒性，从而能够从嘈杂的人群注释中学习。

## A. 理论基础

在这一小节中，我们首先将特征函数的概念从概率分布扩展到密度图（即，有限测度）。然后，我们证明了有限测度的特征函数的一些重要性质。

1)**密度图的特征函数**：在数学中，测度被定义如下。定义1（测度）：一个测度是定义在可测量空间 $(\Omega, F)$ 上的集合函数 $m$ ，其中 $\Omega$ 是全空间， $F$ 是 $\sigma$-代数（包含 $\Omega$ 的子集，这些子集关于并集、交集和补集是封闭的），它满足：
   - (i) 非负性： $m(A) \geq 0, \forall A \in F$ 。
   - (ii) $\sigma$ -可加性： $m(\emptyset) = 0$ ，其中 $\emptyset$ 是空集，且对于一个可数集合 $\{A_ i | A_ i \in F, A_ i \cap A_ j = \emptyset \text{ if } i \neq j\}$ ，有

$$
m(\bigcup_ {i=1}^{\infty} A_ i) = \sum_ {i=1}^{\infty} m(A_ i)
$$

如果 $m(\Omega) < \infty$ ，即总测度是有限的，则它是一个有限测度。

因此，密度图是在2D平面上的一个有限测度； $\Omega$ 是2D欧几里得空间 $\mathbb{R}^2$ ， $F$ 是所有Borel集。

定义2（密度图）：一个人群密度图是定义在 $(\mathbb{R}^2, \mathcal{B}\mathbb{R}^2)$ 上的一个有限测度，其中 $\mathbb{R}^2$ 是2D欧几里得空间， $\mathcal{B}\mathbb{R}^2$ 是 $\mathbb{R}^2$ 上的所有Borel集。密度图在 $\mathbb{R}^2$ 上的总测度是总人数。

一个离散密度图是一个只在一组有限点上分布测度的密度图，即，如果密度图 $m$ 满足以下属性：

$$
m(A) = \sum_ {i=1}^{n} m(\{x_ i\} \cap A), \forall A \in \mathcal{B}\mathbb{R}^2,
$$
   
其中 $x_ i \in \mathbb{R}^2$ 是那些具有非零测度的点，则 $m$ 是一个离散密度图。注意，真实标注的点图（GT dot map）也是一个离散密度图，其中每个具有非零测度的点的值都为1，假设没有两个人可以共享同一位置。

接下来，我们引入特征函数的定义，这是一类具有特殊有限测度的概率分布，其总测度为1。

定义3（分布的特征函数）：给定一个在 $\mathbb{R}^n$ 上定义的分布 $d$ ，其特征函数 $\phi_ d$ 是一个定义在 $\mathbb{R}^n$ 上的复值函数：

$$
\phi_ d(t) = \mathbb{E}_ {X \sim d}[\exp(i\langle t, X \rangle)],
$$

其中 $t \in \mathbb{R}^n$ 是频域的独立变量， $\mathbb{E}_ {X \sim d}$ 是在分布 $d$ 下 $X$ 的期望， $i$ 是虚数单位。

由于概率分布只是具有总测度为1的有限测度，特征函数的定义可以扩展到有限测度（即，密度图）。

定义4（测度的特征函数）：给定一个在 $\mathbb{R}^n$ 上定义的有限测度 $m$ ，其特征函数 $\phi_ m$ 是一个定义在 $\mathbb{R}^n$ 上的复值函数：

$$
\phi_ m(t) = \int_ {\mathbb{R}^n} \exp(i\langle t, x \rangle) \, dm(x),
$$

其中 $dm(x)$ 是基于测度 $m$ 计算的积分。

因此，使用定义2和定义4，我们可以计算密度图的特征函数，将空间信息转换到频域。图2(a)-(c) 显示了一个密度图及其特征函数的示例。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/d8bb7857b6f44eff8e336e5a8696eb9b.png#pic_ center" width="70%" />
</div>

2)**特征函数的性质**：接下来我们推导有限测度的特征函数的几个重要性质。所有证明都在补充材料中。为了清晰起见，我们直接以密度图的形式而不是有限测度的形式呈现这些性质。因此，在剩余部分中，“密度图”一词指的是定义在 $(\mathbb{R}^2, \mathcal{B}\mathbb{R}^2)$ 上的有限测度（见定义2）。

性质1（唯一性）：特征函数唯一地确定了密度图，反之亦然。假设 $\phi_ {m_ 1}$ 和 $\phi_ {m_ 2}$ 是分别从两个密度图 $m_ 1$ 和 $m_ 2$ 派生出的两个特征函数。那么，

$$
\phi_ {m_ 1}(t) = \phi_ {m_ 2}(t) \text{ a.e. (几乎处处) }
$$

如果

$$
m_ 1(A) = m_ 2(A), \forall A \in \mathcal{B}\mathbb{R}^2,
$$

我们表示为 $m_ 1 = m_ 2$ 。在 (4) 中，a.e. 表示 $L(\{t \in \mathbb{R}^2 | \phi_ {m_ 1}(t) \neq \phi_ {m_ 2}(t)\}) = 0$ ，其中 $L$ 是勒贝格测度。见附录 A.2.4 的证明。

备注1：直观上，这个性质表明如果两个密度图的特征函数相同，则两个密度图相同，反之亦然。这个性质主要保证了我们的损失函数中有一个唯一的最优解，而损失函数中非唯一最优解的问题在文献 [24] 中被指出是 BL [22] 的潜在缺陷。

性质2（线性）：假设 $m_ 3$ 是两个密度图 $m_ 1$ 和 $m_ 2$ 的线性组合，

$$
m_ 3 = \alpha m_ 1 + \beta m_ 2, \alpha, \beta \geq 0,
$$

那么

$$
\phi_ {m_ 3}(t) = \alpha \phi_ {m_ 1}(t) + \beta \phi_ {m_ 2}(t).
$$

见附录 A.2.1 的证明。

备注2：这个性质在我们推导真实标注（GT）和预测密度图的特征函数时很有帮助，因为它们是由一些基本单元（例如，单点测度或高斯分布）的线性组合构成的。

性质3（逆变换公式）：对于一个密度图 $m$ ，假设存在一个盒子区域 $A = [a_ 1, b_ 1] \times [a_ 2, b_ 2]$ 在 $\mathbb{R}^2$ 中，其边界测度为零，即

$$
m(\partial A) = 0,
$$

其中 $\partial A$ 表示 $A$ 的边界，那么我们有

$$
m(A) = \lim_ {T \to \infty} \frac{1}{(2\pi)^2} \iint_ {[-T, T]^2} \phi_ m(t) e^{-i\langle t, x \rangle} \, dx \, dt,
$$

其中 $dx$ 和 $dt$ 表示两个积分都是基于勒贝格测度计算的。见附录 A.2.2 的证明。

备注3：这个性质桥接了密度图和其特征函数。图2说明了在 (9) 中的积分的主要贡献来自 $\mathbb{R}^2$ 的一个小的紧凑范围，这意味着每个空间区域的信息都可以通过性质3从紧凑组织好的频域信息中恢复。

性质4（利普希茨连续性）：密度图 $m$ 的特征函数 $\phi_ m(t)$ 是一致连续的。如果 $m$ 是一个离散密度图（见定义2）或与高斯核卷积的离散密度图，那么特征函数 $\phi_ m(t)$ 是利普希茨连续的。见附录 A.2.3 的证明。

备注4：这个性质对于我们基本损失的实现至关重要。我们的基本损失函数没有解析解，但这个性质允许我们通过离散化来近似实现我们的基本损失。

## B. 广义特征函数损失 (Generalized Characteristic Function Loss, GCFL)

我们现在提出我们的广义特征函数损失 (GCFL)。我们从 [33] 中的特征函数 (ChfL) 损失开始，然后推导出 GCFL。给定预测的离散密度图 $m_ p$ 和真实标注 (Ground Truth, GT) 密度图 $\bar{m}_ g$ ，后者是通过将 GT 点图 $m_ g$ 与高斯核卷积得到的，ChfL 损失 [33] 是它们的特征函数 $\phi_ {\bar{m}_ g}$ 和 $\phi_ {m_ p}$ 之间的 L1-范数度量，即：

$$
l_ {chf}(\bar{m}_ g, m_ p) = \int_ {\mathbb{R}^2} \left| \phi_ {\bar{m}_ g}(t) - \phi_ {m_ p}(t) \right| dt
$$

在本文中， $|a|$ 总是表示取复数 $a$ 的模，即 $|a| = \sqrt{\mathbb{R}(a)^2 + \mathbb{I}(a)^2}$ ，其中 $\mathbb{R}(a)$ 和 $\mathbb{I}(a)$ 分别是 $a$ 的实部和虚部。如果 $a$ 是一个实数，则 $|a|$ 是它的绝对值。

在人群计数任务中，我们通常通过将 GT 点图与高斯核卷积来平滑离散密度图 [22], [30], [56], [67]。在我们的框架中，这相当于将高斯窗口乘以点注释图的特征函数。具体来说，设 $m_ g$ 表示 GT 点图，假设有 $M$ 个人位于 $\{ \mu_ j \}_ {j=1}^M$ ，则

$$
m_ g(x) = \sum_ {k=1}^{M} \delta(x - \mu_ j),
$$

其中 $\delta(x)$ 是狄拉克δ函数，我们表示 $\delta_ \mu(x) = \delta(x - \mu)$ 。使用性质2并注意到狄拉克δ函数的特征函数是 $\phi_ {\delta_ \mu}(t) = \exp(i\mu^T t)$ ，我们得到点图的特征函数，

$$
\phi_ {m_ g}(t) = \sum_ {j=1}^{M} \phi_ {\delta_ {\mu_ j}} (t) = \sum_ {j=1}^{M} \exp(i\mu_ j^T t).
$$

GT 密度图通常是通过将点图与高斯分布 $N(0, \Sigma) $ 卷积得到的，因此 GT 密度图 $\bar{m}_ g$ 是 $M$ 个高斯分布的和，

$$
\bar{m}_ g = m_ g \* N(0, \Sigma) = \sum_ {k=1}^{M} \delta_ {\mu_ j} \* N(0, \Sigma),
$$

$$
\Rightarrow \bar{m}_ g(x) = \sum_ {j=1}^{M} N(x|\mu_ j, \Sigma),
$$

其中 * 表示卷积操作。使用性质2并注意到高斯分布 $N(x|\mu, \Sigma)$ 的特征函数是 $\phi_ N (t) = \exp (i\mu^T t - \frac{1}{2}t^T \Sigma t)$ ，我们得到 $\bar{m}_ g$ 的特征函数，

$$
\phi_ {\bar{m}_ g}(t) = \sum_ {j=1}^{M} \exp \left( i\mu_ j^T t - \frac{1}{2}t^T \Sigma t \right).
$$

$$
= \sum_ {j=1}^{M} \exp \left( i\mu_ j^T t \right) \exp \left( -\frac{1}{2}t^T \Sigma t \right).
$$

$$
= \phi_ {m_ g}(t) \exp \left( -\frac{1}{2}t^T \Sigma t \right).
$$

这个结果也与卷积在空间域等同于频域中的乘法这一事实一致。

因此，使用 (16)，我们可以将 (10) 中的损失重写为 GT 点图 $m_ g$ 的形式，

$$
l_ {chf}(m_ g, m_ p) = \int_ {\mathbb{R}^2} \left| \phi_ {m_ g}(t) G(t) - \phi_ {m_ p}(t) \right| dt,
$$

其中 $G(t) = \exp(-\frac{1}{2}t^T \Sigma t)$ 是频域中的高斯窗口。

现在我们可以解释为什么在人群计数中将高斯核与 GT 点图卷积是有益的。具体来说，我们有 $\phi_ {\bar{m}_ g}(t) = \phi_ {m_ g}(t)G(t)$ 。高斯窗口随着频率的增加而指数衰减。因此，乘以高斯窗口将忽略 GT 点图中的高频分量，这对应于局部位置信息。因此，高斯核卷积可以避免对 GT 中的局部位置信息过拟合，从而产生更准确的人群计数预测。

高斯窗口 $G(t)$ 只是频域中窗口函数的一种类型。更一般地，我们提出了一个广义特征损失函数 (GCFL)，

$$
l_ {gchf}(m_ g, m_ p; H, F_ 1, F_ 2) = \int_ {\mathbb{R}^2} H(t) \left| \phi_ {m_ g}(t) F_ 1(t) - \phi_ {m_ p}(t) F_ 2(t) \right| dt,
$$

它由三个窗口函数 $\{H, F_ 1, F_ 2\}$ 参数化，为处理不同的人群分析任务提供了灵活性。

在 (18) 中， $F_ 1$ 控制 GT 信息，即应强调 GT 的哪一部分，忽略哪一部分。 $F_ 2$ 以相反的方式控制预测信息。假设我们希望预测在频域的某个区域响应高值，那么我们可以给 $F_ 2$ 中的相应区域低值。由于损失中使用的最终预测是神经网络预测和窗口 $F_ 2$ 的乘积，那么神经网络必须输出更高的预测值以克服 $F_ 2$ 中的较低乘数因子。 $H$ 控制整体损失行为，其中重要的频率可以给更高的权重，而不重要（或不太确定）的频率给较低的权重。

接下来，我们将展示如何使用我们的 GCFL (18) 来处理人群计数、人群定位和嘈杂人群分析任务。

## C. GCFL 用于人群计数

在人群计数任务中，[33] 中的特征函数 (Chf) 损失 $l_ {chf}$ 是我们 GCFL 的一个特例，使用以下窗口函数：

$$
H(t) = 1, \quad F_ 1(t) = \exp \left( -\frac{1}{2}t^T \Sigma t \right), \quad F_ 2(t) = 1,
$$

其中 $\Sigma$ 是用于构建密度图的高斯核的协方差矩阵。

接下来，我们将介绍 Chf 损失 $l_ {chf}$ 在 (10) 中的一些重要性质。第一个性质是它不是欠定的，即两个不相等的密度图 $m_ 1$ 和 $m_ 2$ 永远不会在它们之间有零损失。正如 [24] 中所指出的，最小化一个欠定的损失可能会导致人群计数性能下降。

**命题 1**：对于真实标注密度图 $\bar{m}_ g$ 和预测密度图 $m_ p$ ，Chf 损失 $l_ {chf}$ ，即具有窗口函数 (19) 的 GCFL，并不会因为 (19) 中的窗口函数而欠定。证明见附录 A.3.1。

接下来，我们提出一个命题来揭示为什么 Chf 损失在人群计数中表现良好。

**命题 2**：对于真实标注密度图 $\bar{m}_ g$ 和预测密度图 $m_ p$ ，

$$
\left| \bar{m}_ g(A) - m_ p(A) \right| \leq (2\pi)^{-2} l_ {chf}(\bar{m}_ g, m_ p) L(A),
$$

对于任何开集 $A \in \mathcal{B}\mathbb{R}^2$ 。这里 $L$ 表示勒贝格测度，即区域 $A$ 的面积。证明见附录 A.3.2。

该命题显示了当 Chf 损失相对于 GT 减少时，预测密度图会发生什么。重排 (20) 中的项，我们得到

$$
(2\pi)^2 \frac{\left| \bar{m}_ g(A) - m_ p(A) \right|}{L(A)} \leq l_ {chf}(\bar{m}_ g, m_ p), \quad \forall A \in \mathcal{B}\mathbb{R}^2.
$$

因此，Chf 损失是所有子区域 $A$ 的归一化计数误差的上界， $\frac{\left| \bar{m}_ g(A) - m_ p(A) \right|}{L(A)}$ ，其中归一化是基于子区域面积 $L(A)$ 。

接下来，我们定义两个密度图之间的“sup 范数”度量，这是所有子区域上最大归一化误差的最大值，

$$
\Delta(\bar{m}_ g, m_ p) = \sup_ {\partial A = \emptyset \land L(A) \neq 0} \frac{\left| \bar{m}_ g(A) - m_ p(A) \right|}{L(A)},
$$

其中 $\partial A = \emptyset$ 表示 $A$ 有空心边界（即，它是一个开集）， $L(A) \neq 0$ 表示它有一个非平凡的勒贝格测度。我们的 sup 范数 (22) 类似于 [5] 中的 MESA（Maximum Excess over SubArrays）损失，只是 MESA 是用矩形区域定义的，并且没有归一化，而我们的是定义在所有子区域上的，并且是归一化的。

最后，我们得到

$$
(2\pi)^2 \Delta(\bar{m}_ g, m_ p) \leq l_ {chf}(\bar{m}_ g, m_ p),
$$

因此，最小化 Chf 损失等同于最小化预测和 GT 之间的 sup 范数度量 $\Delta(\bar{m}_ g, m_ p)$ 的上界，即最小化所有子区域上的最大归一化误差。使用 Chf 损失进行训练将在所有区域计数上均匀地施加监督，避免空间域中个别像素的波动（例如，与像 L2 这样的像素级损失固有的波动）。

在实际实现中，我们采用以下窗口对 GCFL 进行人群计数，

$$
H(t) = \begin{cases} 
1, & t \in [-0.3, 0.3]^2 \\
0, & \text{otherwise}
\end{cases}, \quad
F_ 1(t) = \exp \left( -\frac{1}{2}t^T \Sigma t \right), \quad F_ 2(t) = 1.
$$

与 (19) 相比， $H(t) $ 被截断到以原点为中心的频率范围，因此 (18) 中的积分被限制在 $[-0.3, 0.3]^2$ 。有关更多详细信息，请参见第 IV-A1 节和 V-B3 节。

## D. GCFL 用于局部化
与需要忽略局部细节以防止过拟合的群体计数不同，群体定位需要更多的局部信息以提供精确的位置，尤其是对于微小的密集头部。在频域中，低频分量对应于更平滑的二维正弦波，而高频分量对应于更锐利的二维正弦波。在空间域中重建精确的局部细节需要高频正弦波。因此，我们采用以下窗口函数来处理群体定位的GCFL：

$$
H(t) = \begin{cases} 
1, & t \in [-0.5, 0.5]^2 \\
0, & \text{otherwise}
\end{cases}, \quad F1(t) = 1, \quad F2(t) = 1. \quad (25)
$$

由于定位需要精确的局部信息，使用高斯窗口来平滑局部位置信息是不利的。因此，在公式(25)中，与公式(24)相比，我们去除了高斯窗口。此外，积分范围从 $[-0.3, 0.3]^2$扩展到$[-0.5, 0.5]^2$ ，这包括了更多的高频分量，以便使用更精确的定位信息进行监督。第IV节A2节提供了关于范围选择的更多理论细节，而第V-C2节展示了H窗口范围的消融研究。
**Map scaling**: 在对密集头部进行群体定位模型训练时，我们还可以利用频域中的信息分布，设计一个地图缩放技巧。将信息转换到频域后，大部分信息集中在原点周围的一个小的紧凑范围内。这种属性适用于任何空间信息分布，即无论空间信息的范围有多大，其转换后的频域信息总是在那个小的紧凑范围内。因此，我们可以同时扩展地面真实点图和相应预测密度图的坐标，这样定位误差就会增加。然后GCFL对定位误差更敏感，但不会增加任何额外的时间或空间消耗，由于上述频域信息组织属性。此外，当地面真实点图被缩放时，一些密集的头部更加分离，这使得局部位置信息更清晰。注意，这里我们是缩放地面真实点(例如， $\mu_ j \rightarrow 10\mu_ j$ )和离散密度图中预测密度位置的坐标系统（相当于增加图像分辨率），因此不需要额外的内存和可忽略的额外计算。

## E. 用于嘈杂人群计数的 GCFL

在实际应用中，头部的注释可能并不完全位于头部中心，这可能是由于注释者的粗心或注释任务的模糊性造成的。换句话说，头部注释中存在空间噪声。如何在存在这种噪声的训练数据上训练人群计数模型是一个现实的问题。[23] 已经从空间域的角度研究了这个问题。这里，我们使用 GCFL 从频域的角度来应对这一挑战。

1) 频域中注释噪声的分析。我们从 GT 密度图 $\mg$ 的特征函数 (13) 开始，分析注释噪声如何影响频域信息。假设每个头部 $\mj$ 的注释噪声是一个二维随机向量 $\ej$，那么嘈杂的 GT 密度图 $\mg$ 为：

$$
\mg(x) = \sum_{j=1}^{M} N(x|\mj + \ej, \Sigma)
$$

通过 (16)，我们得到 $\mg$ 的特征函数：

$$
\varphi_{\mg}(t) = \sum_{j=1}^{M} \exp(i(\mj + \ej)^T t - \frac{1}{2}t^T \Sigma t)
$$

将 (27) 与 (14) 比较，注释噪声在频域中引入了额外的项 $\exp(i\ej^T t)$ ，这扰动了频域内容。注意到 $|\exp(i\ej^T t)| = 1$ 始终成立，因此噪声项仅旋转了每个头部的原始频域分量，而不会改变其模。

1.1) 高斯注释噪声。为了进一步分析，我们首先假设注释噪声服从高斯分布。

**命题 3**：假设嘈杂密度图定义在 (26) 中。如果空间注释噪声 $\{\ej\}_ j$ 是独立同分布的 (i.i.d.) 并遵循高斯分布 $N(0, \Lambda)$ ，那么对于嘈杂的特征函数 $\varphi_{\mg}$ ，我们有：

$$
E[\varphi_{\mg}(t)] = \sum_{j=1}^{M} \exp(i\mj^T t) \exp(- \frac{1}{2}t^T (\Lambda + \Sigma)t)
$$

$$
\text{var}(\varphi_{\mg}(t)) = M(1 - \exp(-t^T \Lambda t)) \exp(-t^T \Sigma t)
$$

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/b94fb7b2584e4f3e8c1cc791ecdf9692.png#pic_ center" width="70%" />
</div>

因此，从(30)中，方差图具有两个重要属性：1) 大方差区域在频域中形成一个环带；2) 方差与点图中的总人数M线性相关。

1.2) 非高斯注释噪声。接下来，我们展示了上述方差图的两个性质即使在没有高斯假设的情况下也成立。

**命题 4**：假设嘈杂密度图定义在 (26) 中。设空间注释噪声 $\{\ej\}_ j$ 是 i.i.d. 并遵循分布 X，设 $\varphi_{\mg}$ 是嘈杂的特征函数。那么方差图 $\text{var}(\varphi_{\mg}(t))$ 当 $|t| \to \infty$ 时趋向于 0，并且 $\text{var}(\varphi_{\mg}(t))$ 与 $\mg$ 中的总人数线性相关。

**命题 4** 显示了频域噪声分布的两个性质，无论空间注释噪声的具体分布如何，都成立。在空间域中，头部位置和注释噪声分布的多样性使得不同图像中的噪声联合分布非常不同，这使得在空间域中实现对噪声的鲁棒性变得困难。然而，**命题 4** 揭示了在空间域中不规则分布的注释噪声在频域中被规则地集中在一个环形带中，并且它们的方差与注释点图中的总人数线性相关。这为在频域中处理空间注释噪声提供了一种方便的方法。

2)噪声分布的模拟。为了验证我们的分析，我们进行了统计模拟，检查注释噪声在频域中的影响。给定一个点图，我们通过根据半径为 20 像素的圆盘上的均匀分布向每个点添加空间噪声来模拟嘈杂的点图。然后，我们计算原始点图和嘈杂版本的密度图以及它们的特征函数之间的误差图。将这个过程重复 10,000 次，我们为每个点图获得一个方差图。最后，我们对 JHU++ 数据集训练集中的 2,000 个点图执行此过程，从而获得 2,000 个方差图。

图 3(b)-(d) 显示了三个具有不同计数的点图的误差方差图示例。在频域中，空间注释噪声在原点周围的环形区域内引起特征函数的扰动。请注意，方差的比例随着原始点图中的人数而变化。通过归一化误差方差图并取平均值，我们得到了图 3(e) 中的一致误差图，该图说明了误差方差与真实计数之间确实存在线性相关性。

3)噪声鲁棒窗口

利用我们的分析，我们设计了一个适当的动态窗口函数 H(t)，它较少关注环形带中的信息，这使得模型训练对空间注释噪声具有鲁棒性。设 h(t) 是图 3(e) 中的平均归一化方差图，则我们为每张图像定义了一个动态窗口函数 H(t)：

$$
H(t) = \begin{cases} 
1 / \sqrt{h(t) \cdot M}, & t \in [-0.3, 0.3]^2 \\
0, & \text{otherwise}
\end{cases}
$$

其中 M 是地面真实 mg 中的总人数，因此 h(t) · M 是每个图像的误差方差图。H(t) 是标准差图的倒数，其中具有大方差的位置将具有较低的权重，因此 GCFL 将较少关注这些位置。请注意，即使应用此窗口 H，频域中的总体计数，即 t = 0 处的值，仍然保持不变，因此在训练期间计数不会受到影响。我们使用 (31) 中的窗口进行嘈杂人群计数任务。

# IV. 实现广义特征函数损失 (GCFL)

由于(18)中的GCFL积分没有解析解，我们首先提出使用理论和经验支持的GCFL的近似实现。然后，我们通过分析反向传播的梯度来修改实现的损失，并提出一个修改后的GCFL损失，该损失具有更稳定的训练和更低的重复运行结果方差。这些特性使其非常适合实际应用。

## A. 近似积分

要接近（18）GCFL，需要两个步骤：1）确定定义的整体范围；2） 使用黎曼sum来近似这一定义中的积分。

### 1) 将积分截断到有限范围

如图 2 所示，特征函数在紧凑的中心范围之外的值通常非常小。因此，可以使用窗口函数  $H$  对积分进行截断。实证和理论证据也支持这种截断。理论上，我们有以下原始密度图和重建密度图之间误差的上限。

**命题 5**：假设密度图  $m$  是通过将离散点图与带宽为  $\sigma$  的高斯核卷积获得的，重建的密度图  $\tilde{m}$  是从限制在圆盘  $B(0, r)$  上的特征函数  $\phi_ m$  获得的。设  $T$  是  $m$  的总度量。那么在任何非空盒子区域  $A$  上，其中边界  $\partial A = 0$ ，我们有

$$
|m(A) - \tilde{m}(A)| / L(A) \leq T \exp( -\frac{\sigma^2 r^2}{2} ) / (2\pi\sigma^2)
$$

其中  $L(A)$  是区域  $A$  的勒贝格度量，即区域  $A$  的面积。证明见附录 A.3.5。

命题5表明，当我们使用高斯核从差分图生成G密度图时，理论和重构的G密度图之间的误差可以由一个指数衰减项来约束。图4显示了理论原始密度图和从运行特征函数构建的密度图之间的比较。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/267b15c4c21c4bfbb39b432e79f923e5.png#pic_ center" width="70%" />
</div>

### 2) 不带低通滤波器的截断

如果我们不对原始的GT点图进行高斯窗口（或任何其他平滑窗口）的卷积，那么即使在没有低通滤波器的情况下，截断仍然会对训练产生影响。

根据定义2，该位图也是一个扫描密度图，因此，以下建议适用于全局真理点图和预测的离散密度图。

**命题 6**：考虑一个离散密度图  $m$ ，其度量分布在  $N$  个点  $\{p(1), ..., p(N)\}$  上。设  $\tilde{m}$  是从限制在正方形  $[-a, a]^2$  上的特征函数  $\phi_ m$  重建的密度图。那么在任何非空盒子区域  $A$  上，其中边界  $\partial A = 0$ ，我们有

$$
\tilde{m}(A) = \sum_ {k=1}^{N} m(p(k)) \int_ {A} \frac{2}{\pi} \sin((p(k)_ d - x_ d)a) / (p(k)_ d - x_ d) dx
$$

这里下标表示  $p(k)$  或  $x$  的第一个和第二个坐标。证明见附录 A.3.6。

将积分中的被积函数表示为

$$
f(k)(x) = \frac{2}{\pi} \sin((p(k)_ d - x_ d)a) / (p(k)_ d - x_ d) = \frac{a^2}{\pi^2} \sum_ {d=1}^{2} \text{sinc}((p(k)_ d - x_ d)a)
$$

其中  $\text{sinc}(x) = \sin(x) / x$ ，并且

$$
f(x) = \frac{a^2}{\pi^2} \sum_ {d=1}^{2} \text{sinc}(x_ d a)
$$

**命题 6** 表明，截断积分实际上相当于将频率分量乘以矩形窗口，这对应于将点图与  $\text{sinc}$  函数卷积。 $\text{sinc}$  函数的分量紧密地集中在中心附近，并且在第一个零点之后迅速衰减到 0（在主瓣之外），这表明将积分截断到一个小范围是可行的。因此，将离散密度图中的特征函数截断相当于将注释点处的极集中的单例度量分布到其邻近像素。这是一种度量平滑，防止过拟合，因为神经网络的预测不必精确地在地面真实点位置上。这也与频域中的情况一致。由于高频分量通常对应于噪声部分，截断积分意味着丢弃高频分量，这可以防止对噪声的过拟合。

图 5 显示了一个示例。在空间域中，空间单位是图像像素。因此，离散密度图中具有度量  $v$  的单个像素类似于以像素位置为中心的圆盘，其半径为几个像素，其总度量也接近  $v$ 。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/c32ed126b435453b9b1958dadffcde3d.png#pic_ center" width="70%" />
</div>

### 3) 使用黎曼和近似积分

尽管 GCFL 积分被限制在一个很小的范围内，但它仍然需要用黎曼和来近似。命题 4 显示了特征函数的利普希茨连续性，为黎曼和近似提供了坚实的理论保证。此外，第 V-B3 节将展示一些经验结果。

实现 GCFL 时使用黎曼和近似的示意图如图 6 所示。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/27fe785a9d55406b859fe160d80e112a.png#pic_ center" width="70%" />
</div>

对于给定的图像，假设 GT 中有 M 个人位于 ${μj}Mj=1$ 的位置。点图的特征函数是 (12)。设 $P(x)$ 为对应于预测密度图在空间位置 $x$ 处的值的 2D 矩阵中的值。预测密度图 $mp$ 也是由单例度量堆叠而成，根据属性 2 我们有

$$
\varphi_ {m_ p}(t) = \int x P(x) \varphi_ {\delta_ x} = \int x exp(ix^T t) P(x)
$$

在黎曼和近似中，将积分范围 $[-a, a]^2$ 平均分成小的正方形网格。设 R 是网格中心点的集合，其中正方形网格的边长为 c。然后，GCFL 的实现是

$$
\hat{l}_ {gchf}(m_ g, m_ p) = c^2 \sum_ {t \in R} H(t) | \varphi_ {m_ g}(t) F_ 1(t) - \varphi_ {m_ p}(t) F_ 2(t) |^2
$$

$$
= c^2 \sum_ {t \in R} H(t) \left( \sum_ {j=1}^{M} exp(i \mu_ j^T t) - \sum_ x exp(ix^T t) P(x) \right)^2
$$

近似引入了我们方法中的两个超参数：1) 黎曼和中网格的粒度 (c)；2) 积分范围 (a)。属性 4 的重要后果是将这两个超参数解耦。属性 4 展示了特征函数的均匀连续性，这意味着连续性的强度在整个域中是相似的。因此，如果黎曼和近似的粒度在原点附近工作得很好，那么它在任何积分范围内也很好。因此，黎曼和近似的粒度与积分范围无关。结果，超参数搜索从二维网格搜索转换为两个一维线搜索，这更有效。此外，黎曼和近似的粒度与积分范围的独立性保证了我们可以为人群计数和人群定位使用相同的粒度设置，一旦对人群计数执行了消融研究，就不需要对粒度进行额外的消融研究。

## B. 提高训练稳定性

上述实现可能在人群计数任务中具有不稳定的训练过程，这会导致不同试验结果之间的大差异，这可能限制了其在实际应用中的用途。因此，我们提出了两种变体来改进 $$\hat{l}_ {gchf}$$ 的训练稳定性。

为了清晰起见，我们首先假设 $$H(t) = F_ 1(t) = F_ 2(t) = 1$$ 进行分析，并在最后将这三个窗口函数加回。现在 (40) 变为：

$$
\hat{l}_ {gchf}(m_ g, m_ p) = c^2 \sum_ {t \in R} | \varphi_ {m_ g}(t) - \varphi_ {m_ p}(t) |^2
$$

我们首先将集合 R 写成：

$$
R = \{(t_ 1, t_ 2) | t_ 1 \in R_ 1, t_ 2 \in R_ 2\}
$$

其中 R1 和 R2 是频率平面上 t1 和 t2 轴的坐标集。然后我们可以展开 (42) 为：

$$
\hat{l}_ {gchf}(m_ g, m_ p) = c^2 \sum_ {t_ 1 \in R_ 1} \sum_ {t_ 2 \in R_ 2} (\text{Re}(\Delta(t_ 1, t_ 2))^2 + \text{Im}(\Delta(t_ 1, t_ 2))^2)
$$

其中 ℜ 和 ℑ 分别表示取复数的实部和虚部，Δ(t1, t2) 定义为：

$$
\Delta(t) = \Delta(t_ 1, t_ 2) = \varphi_ {m_ g}(t_ 1, t_ 2) - \varphi_ {m_ p}(t_ 1, t_ 2)
$$

我们接下来定义我们的两种 GCFL 变体，

$$
\bar{l}_ {gchf}(m_ g, m_ p) = c^2 \sum_ {t_ 1 \in R_ 1} \sum_ {t_ 2 \in R_ 2} \frac{\text{Re}(\Delta(t_ 1, t_ 2))^2 + \text{Im}(\Delta(t_ 1, t_ 2))^2}{Q(t)}
$$

和

$$
\tilde{l}_ {gchf}(m_ g, m_ p) = c \sum_ {t_ 1 \in R_ 1} \sum_ {t_ 2 \in R_ 2} \frac{\text{Re}(\Delta(t_ 1, t_ 2))^2 + \text{Im}(\Delta(t_ 1, t_ 2))^2}{\tilde{l}_ {gchf}(m_ g, m_ p)}
$$

注意，减少 (46) 和 (47) 中的损失也会导致 (40) 中的损失减少，反之亦然。通过分析它们相对于输出预测值的导数，我们可以检查使用这些损失进行训练的行为。由于常数 c 和 c^2 被吸收到学习率中，我们首先通过去除这些常数来归一化损失函数。对于位置 x 的输出预测值，损失相对于 P(x) 的导数是（见附录 B 推导）：

$$
\frac{\partial \hat{l}_ {gchf}(m_ g, m_ p)}{\partial P(x)} = \sum_ {t \in R} \frac{\langle d(t), -f_ x(t) \rangle}{\|d(t)\|^2},
$$

$$
\frac{\partial \bar{l}_ {gchf}(m_ g, m_ p)}{\partial P(x)} = \sum_ {t \in R} \frac{\langle d(t), -f_ x(t) \rangle}{Q(t)},
$$

$$
\frac{\partial \tilde{l}_ {gchf}(m_ g, m_ p)}{\partial P(x)} = \sum_ {t \in R} \frac{\langle d(t), -f_ x(t) \rangle}{\frac{1}{c}\tilde{l}_ {gchf}(m_ g, m_ p)},
$$

其中

$$
Q(t) = \sum_ {t \in R_ 2} (\text{Re}(\Delta(t_ 1, t))^2 + \text{Im}(\Delta(t_ 1, t))^2)
$$

并且

$$
1/c\tilde{l}_ {gchf}(m_ g, m_ p) = \sum_ {t_ 1 \in R_ 1} \sum_ {t_ 2 \in R_ 2} (\text{Re}(\Delta(t_ 1, t_ 2))^2 + \text{Im}(\Delta(t_ 1, t_ 2))^2)
$$

从 (52)、(53) 和 (54) 中，我们得到分母之间的以下关系：

$$
\|d(t)\|^2 < Q(t) < \frac{1}{c}\tilde{l}_ {gchf}(m_ g, m_ p)
$$

因此，这三种损失在优化过程中表现出不同的行为。 $\hat{l}_ {gchf}$ 采用了每次训练步骤中最激进的优化策略，因为它的导数具有最小的分母。相比之下， $\tilde{l}_ {gchf}$ 是最保守的优化策略，因为它的导数具有最大的分母。最后， $\bar{l}_ {gchf}$ 在 $\hat{l}_ {gchf}$ 和 $\tilde{l}_ {gchf}$ 之间。

从 SHTCA ($\hat{l}_ {gchf}$ 对比 $\bar{l}_ {gchf}$ ，见图 7) 和 SHTCB ($\hat{l}_ {gchf}$ 对比 $\tilde{l}_ {gchf}$ ，见图 8) 的训练结果来看， $\hat{l}_ {gchf}$ 的激进优化策略产生了不稳定的训练过程，以及不同运行结果之间的更高方差。变体 $\bar{l}_ {gchf}$ 和 $\tilde{l}_ {gchf}$ 缓解了这些缺点。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/6054497d980c4e3183801f5a71b6555d.png#pic_ center" width="70%" />
</div>

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/4bdcac71c7a14bab96713e9867c12121.png#pic_ center" width="70%" />
</div>

最后，我们将 H(t)、F1(t) 和 F2(t) 重新添加到改进中，得到最终版本，

$$
\bar{l}_ {gchf}(m_ g, m_ p; H, F_ 1, F_ 2) = c^2 \sum_ {t_ 1 \in R_ 1} \sum_ {t_ 2 \in R_ 2} Q(t) (\text{Re}(\Delta(t_ 1, t_ 2))^2 + \text{Im}(\Delta(t_ 1, t_ 2))^2
$$

和

$$
\tilde{l}_ {gchf}(m_ g, m_ p; H, F_ 1, F_ 2) = c \sum_ {t_ 1 \in R_ 1} \sum_ {t_ 2 \in R_ 2} \frac{\text{Re}(\Delta(t_ 1, t_ 2))^2 + \text{Im}(\Delta(t_ 1, t_ 2))^2}{\tilde{l}_ {gchf}(m_ g, m_ p)}
$$

其中

$$
\Delta(t_ 1, t_ 2) = H(t_ 1, t_ 2)(\varphi_ {m_ g}(t_ 1, t_ 2)F_ 1(t_ 1, t_ 2) - \varphi_ {m_ p}(t_ 1, t_ 2)F_ 2(t_ 1, t_ 2))
$$

我们使用 (57) 中的变体进行人群计数，以便使训练更加稳定。如果数据集中有更多拥挤人群的图像，那么我们就使用 (56) 中的更激进版本。


# V. 实验

在本节中，我们展示了使用我们的广义特征函数损失（GCFL）进行人群计数、定位和嘈杂人群计数的实验。

## A. 实验设置

我们在五个基准数据集上进行了人群计数任务：ShanghaiTech A & B [30]、UCF-QNRF [67]、JHU++ [68]、[69] 和 NWPU [29]。按照惯例，人群定位在 UCF-QNRF 和 NWPU 上进行。对于嘈杂人群计数，我们通过向原始的地面真实（GT）添加不同级别的噪声，从 UCF-QNRF 构建了 5 个不同的嘈杂人群数据集。对于 UCF-QNRF，我们将每张图像调整大小，使其最短边不超过 1536 像素。对于 JHU++ 和 NWPU，我们执行类似的调整，长度为 2048 像素。图像裁剪大小为 UCF-QNRF、JHU++ 和 NWPU 的 384 像素，ShanghaiTech A 的 128 像素，以及 ShanghaiTech B 的 512 像素。

我们使用了与 [22]、[23]、[24]、[25] 中相同的密度图回归深度神经网络（DNN），包括 VGG19 [70] 的特征提取层连接到由三个卷积层组成的回归模块。对于我们的损失函数，我们使用 Adam [71] 优化器，学习率为 1e-5，权重衰减为 1e-4。如果使用高斯窗口，协方差矩阵始终是沿着对角线的矩阵，对角线设置为 64，这遵循了在空间域中将高斯核设置为带宽 8 像素的惯例。在黎曼和逼近中，网格粒度设置为所有数据集的 0.01。

对于我们的 GCFL，我们使用 (24) 中的窗口函数进行人群计数和稀疏头部的定位，我们称之为 GCFL-CC。对于非稀疏头部的人群定位，我们使用 (25) 中的窗口，记为 GCFL-CL，我们使用 (31) 中的 GCFL 进行嘈杂人群计数，记为 GCFL-NCC。为了清晰起见，我们在实验结果中使用 GCFL 表示我们的方法，其中我们将它与 SOTA 进行比较。在消融研究中，我们使用特定名称 GCFL-CC、GCFL-CL 和 GCFL-NCC。在人群计数中，我们在密集数据集 QNRF 和 SHTCA 上应用了 (56) 中的变体损失，而在其他数据集 SHTCB、JHU++ 和 NWPU 上应用了变体损失 (57)。对于人群定位，我们在训练过程中对地面真实和预测点图使用了 10 的映射缩放因子。

## B. 人群计数

人群计数的评估指标遵循标准惯例：采用平均绝对误差（MAE）和均方根误差（MSE）。

1)**损失函数的比较**：首先，我们在表 I 中比较了我们的 GCFL 与 SOTA 损失函数在人群计数中的表现。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/7bf42b2eb0a54c629787310a6fce2181.png#pic_ center" width="70%" />
</div>

所有损失都使用了 [22] 中相同的网络架构。我们的损失在所有数据集上都优于其他损失。此外，[24]、[25] 需要在每个训练批次中运行几十甚至几百次外部 Sinkhorn 算法 [32]，而 [23] 需要在每个训练批次中反转大型矩阵。然而，GCFL 不需要任何其他外部算法，且使用标准张量运算可以快速完成计算。

表 II 显示了这些损失函数之间的效率比较。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/9dbfad1ad7b44340b9c84b6038a6004c.png#pic_ center" width="70%" />
</div>

由于所有损失在训练阶段都使用了相同的网络架构，这里省略了相同的推理时间。除了 L2 基线之外，BL [22] 是最高效的损失函数，但性能最差。我们的 GCFL 具有第二高的效率，以及第二低的超参数数量，同时还实现了最佳的 MAE 和 MSE。请注意，我们只使用了 300 张训练图像来计算时间，随着训练规模和训练周期数的增加，效率优势将增加。

2)**与 SOTA 的比较**：表 III 显示了我们的损失与当前 SOTA 的比较。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/c91b51a276ae4bed82ddba3dddb782e8.png#pic_ center" width="70%" />
</div>

为了公平，这次比较只考虑了使用单个模型并单独在各个数据集上训练的方法。尽管我们的方法很简单，但我们的 GCFL 在大规模数据集上与当前 SOTA 竞争，获得了 UCF-QNRF、JHU++ 和 NWPU 上的最低 MAE/MSE。我们的方法在 ShanghaiTech A 和 B 上也获得了竞争性的结果，但这两个数据集较小，不太能代表泛化能力。这些比较结果展示了在频域中监督人群计数的潜力。

我们还在表 III 中比较了我们方法与其他最近算法的效率。我们的方法在训练时比 P2PNet 快 4 倍（尽管 P2PNet 使用了更小的图像尺寸），比 KDMG 快 5.4 倍。在推理上，我们的方法与 KDMG 的运行时间相同，因为它们都使用了相同的架构，并且比 P2PNet 快约 41%。

3)**消融研究**：GCFL-CC 的积分近似引入了两个额外的超参数：积分范围 a 和黎曼和逼近中的网格粒度 c。如第 IV 节所述，性质 4 将这两个超参数解耦，因此对每个超参数分别在上海技术 A 上进行消融研究。

图 9(a) 显示了不同积分范围的结果。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/2027de96196b497d9a1581bd9443dd4d.png#pic_ center" width="70%" />
</div>

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/f13d13497ae84d5785f2ce320fa237b9.png#pic_ center" width="70%" />
</div>

一般来说，计数性能对不同的积分范围具有鲁棒性。当范围超过 [-0.3, 0.3]^2 时，性能逐渐下降，这表明这个范围之外的频率信息可能会导致过拟合。在实践中，我们将范围固定在 [-0.3, 0.3]^2。

图 9(b) 显示了不同网格粒度的计数结果。当粒度太粗糙，即粒度为 0.1 时，误差显著增加。当粒度低于 0.04 时，性能对粒度的变化不太敏感。由于较小的粒度意味着更多的网格，这对应于更多的内存/计算，我们在实践中将粒度设置为 0.01。

我们接下来展示了 GCFL 改进不同网络结构性能的能力。我们将 GCFL 与 L2（MSE）损失在三个典型的网络结构上进行了比较：基于 CNN 的 CSRNet [14]、VGG19 [22] 和基于变换器的 MAN [81]，根据它们的学习能力进行排列（最后一个最强）。实验在 QNRF 数据集上进行，结果如表 V 所示。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/0bee2b29bea34c68a8db4dffcf718563.png#pic_ center" width="70%" />
</div>

无论使用哪种网络结构，GCFL 都能提高 MSE 的性能，尽管随着网络学习能力的增强，改进幅度会减小（即 MAN）。网络结构的设计和损失函数都可以提高从训练数据中学习的能力。

最后，我们注意到基于变换器的网络（例如 MAN）创建了特征之间的长距离交互，然后用于预测每个输出。相比之下，我们的 GCFL 在输出上应用了频域变换，更好地表示了输出之间的长距离相关性（交互）。因此，变换器架构和 GCFL 是互补的，结果表明，与 MSE 损失相比，变换器仍然能从使用我们的 GCFL 中受益。

## C. 人群定位

接下来，我们使用 GCFL 对人群定位进行训练的实验。为了在预测的密度图中定位人群，我们使用与 [29] 的官方代码类似的策略。输出密度图首先被上采样到与输入图像相同的大小，然后使用步长为 1 的 3 × 3 最大池化来寻找局部最大值。选择大于阈值的局部最大值作为最终的定位点。我们不使用繁琐的微调方法来找到适当的阈值，而是使用一种自动方法来动态决定每个密度图的阈值。具体来说，由于我们相信 GCFL-CC 的人群计数结果，密度阈值被设置为使定位点的数量最接近 GCFL-CC 预测的人群计数。

我们最终的定位结果结合了 GCFL-CL 和 GCFL-CC 的结果。具体来说，对于 GCFL-CC 的定位结果，我们首先删除了距离另一个定位点 60 像素以内的定位点，以便只保留稀疏的定位点。然后，如果没有来自 GCFL-CL 的定位点在 60 像素内，我们将这些剩余的 GCFL-CC 点添加到 GCFL-CL 的定位结果中。

1)**与 SOTA 的比较**：我们按照惯例在 NWPU 和 QNRF 数据集上进行测试。对于 NWPU，结果是通过官方网站计算的，该网站根据总真正数量、预测点数和地面真实点数计算精度、召回率和 F1 度量。对于 QNRF，没有官方代码进行评估，原始论文的评估方法也不够清晰。因此，我们使用了最近的 SOTA [27] 的评估代码。具体来说，使用 1 到 100 的距离阈值计算预测和地面真实定位点之间的 1 对 1 匹配。对于每个阈值，根据映射结果计算精度和召回率。然后，对于每张图像，计算所有图像的平均精度和召回率值。最后，报告所有图像的平均精度和召回率的平均值，以及 F1 度量。

表 VI 显示了 QNRF 上的比较结果。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/e6dbe6143c3a4535baf77bdd31962378.png#pic_ center" width="70%" />
</div>

我们的方法获得了最好的召回率和 F1 度量，以及仅次于 TopoCount [27] 的最佳精度。请注意，TopoCount 需要手动设置图像中头部的框范围，而我们的方法不需要。表 VII 显示，我们的方法在具有挑战性的 NWPU 数据集上也实现了最好的召回率和 F1 度量，而它的精度仅次于 GL [25]。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/42e456ec838641639b39315e378bdcb5.png#pic_ center" width="70%" />
</div>

然而，GL 以牺牲相对较低的召回率为代价获得了高精度，而我们的方法在所有比较的方法中具有最高的召回率和最好的 F1 度量。

2)**消融研究**：我们接下来在 QNRF 上进行消融研究。正如我们在第 IV 节中所述，我们不需要对黎曼和逼近的网格粒度进行消融研究，因为这已经在第 V-B3 节中进行了。

**积分范围**：我们首先探索适当的积分范围，结果如表 VIII 所示。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/e64ba057b0df4ed8b3d1deb7aa81aba8.png#pic_ center" width="70%" />
</div>

将积分范围从 [-0.5, 0.5]^2 扩展到 [-0.7, 0.7]^2 会降低定位性能，这表明添加太多的局部细节会导致过拟合。使用积分范围 [-0.3, 0.3]^2 与范围 [-0.5, 0.5]^2 相比，去除了更多的高频分量，导致局部信息拟合不足。因此，总体而言，使用 [-0.5, 0.5]^2 作为积分范围是最佳选择。

**映射缩放**：我们研究了人群定位的映射缩放因子，同时将积分范围设置为 [-0.5, 0.5]^2。表 IX 显示了不同映射缩放因子的结果。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/d4b05f31f35d4e1d8586d7833e7f6a84.png#pic_ center" width="70%" />
</div>

映射缩放在提高定位结果方面是有效的，到一定程度。之后，更大的缩放因子更多地关注定位误差，导致过拟合。因此，我们相应地选择因子 10。

**窗口函数 H**：我们使用 H(t) 函数来控制我们的 GCFL 的行为。表 X 显示了不同 H(t) 对人群定位的影响。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/91dd1ac29085445fad3913fe9fca2e83.png#pic_ center" width="70%" />
</div>

这些 H(t) 的原型对应于不同的策略，即较少关注原点附近的频率分量，这更多是关于全局空间信息。我们的想法是，这可能会使 GCFL 比较更多地关注局部空间信息，这可能有助于定位。窗口 H2 和 H3 逐渐衰减低频分量（例如，见图 10(a)）。窗口 H4 和 H5 均匀地给予原点周围的区域较低的权重（见图 10(b)）。最后 H6 来自 (31) 中的噪声鲁棒窗口。在这里，我们只使用每种窗口原型的最佳超参数设置。表 X 中的结果表明，所有原型都获得了比窗口 H1 差的定位结果。因此，原点周围的频率信息，即全局空间信息，对于非稀疏头部的人群定位也很重要。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/650f091be6484a6682a5bf415fca23b0.png#pic_ center" width="70%" />
</div>

**每个项的贡献**：为了获得最终的定位结果，我们用 GCFL-CC 定位的稀疏头部补充了 GCFL-CL 的结果。GCFL-CL 用于训练模型以获得基本的人群定位结果，映射缩放用于改进定位结果。表 XI 显示了每个部分的效果。映射缩放对于同时提高精度和召回率是有用的。来自 GCFL-CC 的补充可以进一步提高 F1 度量。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/8847e913530c4a91b155a50d61998721.png#pic_ center" width="70%" />
</div>

## D. 嘈杂人群计数

在本节中，我们使用 GCFL-NCC 进行实验，该实验使用 (31) 中的噪声鲁棒窗口。我们首先展示 GCFL-NCC 在标准（无噪声）数据上对人群计数结果的影响不大。表 XII 显示了 GCFL-NCC 与 GCFL-CC（使用 (24) 中的窗口）的比较。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/6fd0b923aedf4ba59d5c39996765dd05.png#pic_ center" width="70%" />
</div>

在大多数这些数据集上，GCFL-NCC 获得了与 GCFL-CC 类似结果。在上海技术 A 上，由于存在一些注释噪声，因此使用噪声鲁棒窗口的结果比使用计数窗口更好。

接下来，我们展示了 GCFL-NCC 在带有注释噪声的数据集上的鲁棒性。我们通过重新生成点图来模拟嘈杂的数据，由于高斯分布在原点附近是尖峰的，我们转而采用在圆盘上均匀分布的方法来增加噪声水平。每个原始注释被随机选择的样本替换，该样本从一个以原始注释位置为中心的圆盘上均匀分布。圆盘的半径决定了噪声水平，在本实验中，我们使用了 5 个噪声水平，分布半径为 {20, 30, 40, 50, 60}。我们与其他 SOTA 损失进行了比较，图 11 展示了结果。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/a5ca6653ce5844c5a8d18c730dd983f9.png#pic_ center" width="70%" />
</div>

对于不同的噪声水平，GCFL-NCC 几乎总是实现了最低的 MAE 和 MSE，这表明与其它损失相比，GCFL-NCC 对注释噪声具有更强的鲁棒性。在噪声水平 30 上，GCFL-NCC 的 MSE 性能略逊于 NoiseCC[23]。然而，NoiseCC 对其超参数很敏感 - 对于不同的噪声水平，需要为每个噪声水平调整超参数 α（即他们模型中注释噪声的高斯分布的带宽）。在我们的实验中，α 的值设置为与噪声水平相同的值。相比之下，对于 GCFL-NCC，相同的超参数设置适用于实验中的所有噪声水平，因此 GCFL-NCC 对其超参数设置具有鲁棒性，并且更适用于实际应用。

# VI. 结论

在本文中，我们提出了一种用于人群分析的频域中的广义特征函数损失（GCFL）。GCFL 包括两个步骤：1）将空间信息转换到频域；2）计算频域信息之间的损失。在第一步中，我们通过扩展特征函数的定义并证明了一系列重要的性质，建立了理论基础。在第二步中，我们使用窗口函数使 GCFL 能够灵活应对各种任务，并引入了方便高效的真实应用近似实现。

通过利用不同的窗口函数，GCFL 能够解决不同的人群分析任务。在本文中，我们展示了三个示例：人群计数、人群定位和嘈杂人群计数。在为这三个任务设计窗口函数的过程中，我们发现了一些人群信息在频域中的有趣性质，这表明与空间域相比，频域在信息组织方面具有优势。未来的工作将考虑为 GCFL 设计定制的窗口函数，以应用于更多的人群分析任务，例如，基于 MSE 损失的图像人群计数框架 [87]、[88]，以及将 GCFL 扩展到时空频域，用于视频人群计数，这可能会在时间和与人们运动约束相关的时间窗口中引入额外的频率转换。
