# 题目：[Semi-Supervised Learning for FGVC With Out-of-Category Data](https://ieeexplore.ieee.org/document/10273439/)  
## 半监督学习在带有非类别数据的细粒度视觉分类中的应用
**作者：Ruoyi Du, Dongliang Chang, Zhanyu Ma, Kongming Liang, Yi-Zhe Song, Jun Guo** 


****


## 摘要
尽管在细粒度视觉分类（FGVC）上取得了巨大进展，但当前方法仍然严重依赖于需要大量专家标签的全监督范式。半监督学习（SSL）技术通过获取未标记数据的知识，提供了向前发展的可观手段，并对粗粒度问题显示出巨大潜力。然而，现有的SSL范式大多假设类别内（即与类别对齐的）未标记数据，这限制了它们在FGVC上的重新提出时的有效性。在本文中，我们提出了一种新的设计，专门针对使类别外数据适用于半监督FGVC。我们基于一个重要的假设，即所有细粒度类别自然遵循层次结构（例如，涵盖所有鸟类物种的“Aves”的系统发育树）。因此，我们不是在单个样本上操作，而是可以预测树结构内样本的关系作为SSL的优化目标。除此之外，我们进一步引入了由这些树结构独特带来的两种策略，以实现样本间一致性正则化和可靠的伪关系。我们的实验结果揭示了（i）所提出的方法对类别外数据具有良好的鲁棒性，以及（ii）它可以与先前技术结合使用，提升它们的表现，从而获得最先进的结果。
## 关键词
- 细粒度视觉分类，半监督学习，类别外数据。

# I. 引言
在计算机视觉领域取得的进展在很大程度上依赖于获取标注数据。然而，这代表了细粒度视觉分类（FGVC）问题的一个重大限制，其中标签只能由专家提供，即那些能够区分“美国乌鸦”和“鱼鸦”的人。这意味着尽管取得了[1][2][3][4][5][6][7][8]中提到的巨大进展，我们对FGVC的理解在很大程度上仍然局限于完全监督的范式，这些范式已经在专家精心策划的类别上进行了研究，例如鸟类[9]、花卉[10]、汽车[11]。

对于粗粒度问题，已经通过半监督学习（SSL）[12]等手段取得了显著进展，以解决这种“标签缺乏”的现象。然而，可以认为，尽管SSL很重要，但对于粗粒度问题，退回到完全监督的选择是可行的，即更多的人类（非专家）标签总是可以通过努力获得的（在工业界这可能是常见的做法）。然而，对于FGVC来说，无论资源和努力如何，情况并非如此——最终可能根本没有足够的专家可供标记。实际上，拥有足够的标记训练数据对FGVC来说可能本身就是一个错误的论点，这使得SSL对FGVC来说变得更加重要。

然而，在FGVC的背景下，SSL并不简单。实验表明，几乎所有的SSL方法在存在类别外样本[13][14][15]的情况下效果都较差，无论是粗粒度还是细粒度场景——即使是像FixMatch[16]和FlexMatch[17]这样的高级SSL方法，在Semi-Aves上也分别遭受了大约7.5%和3.5%的性能下降（见表II）。这背后的直观原因是对类别外数据的不一致预测——因为它们不包括在标签空间内，模型无法给出有意义的预测，而是给出随机的类别内预测，如图1(a)所示。因此，对于伪标记方法，不一致的预测直接导致无意义的人工标签；对于一致性正则化方法，当模型预测在样本间剧烈变化时，单独追求单个样本的预测一致性也不太有助于区分性知识挖掘。

<div align=center>
    <img src="https://img-blog.csdnimg.cn/direct/5b267965d3b6478fb1900b67e9d9b34c.jpeg" width="70%" />

</div>

<div align=center>  
  <img src="https://img-blog.csdnimg.cn/direct/aeeff188055f4d78a044f7e5ac16e556.jpeg" width="70%" />

</div>


此外，如图1(a)所示，与粗粒度相比，细粒度分类器的特征空间要紧凑得多，使得新的类别外未标记数据（用红圈表示）更容易混淆。为了进一步验证我们的观点，我们模拟了两种情况，使某些类别对模型来说是类别内的或类别外的，并测量模型预测的概率分布通过Kullback-Leibler散度有多分散。从图1(b)中，我们可以得出结论，（i）模型通常对类别外数据（即红色条显著高于蓝色条）产生更不一致的预测，以及（ii）这一现象在细粒度模型中更为显著（即细粒度情况下红色和蓝色之间的差距比粗粒度的大）。这基本上使得大多数现有的依赖于伪标记[19][20][21]或一致性正则化的SSL工作[22][23][24][25]在重新用于FGVC时显著效果不佳。这是因为它们大多在以下假设下工作：（i）获取类别内未标记数据相对容易，以及（ii）类别外问题在粗粒度决策空间中不是那么突出。

在本文中，我们提出了一种新的设计，专门针对FGVC问题中的类别外数据。然而，要理解FGVC固有的紧密决策空间并不简单——我们需要所有可能的帮助。为此，我们从[26]中获得灵感，利用细粒度类别的标签层次结构（例如，“Aves”的系统发育树）。如图2所示，系统发育树提供了所有鸟类物种自然遵守的底层结构。例如，模型无法判断未标记的鸟类是“领鸻”，因为它完全超出了训练标签空间。但模型可以合理地推断它与“半蹼鸻”属于同一属，但不是“半蹼鸻”，即，与图2中定义的“同一属，不同种”与“半蹼鸻”拥有关系。因此，我们的主要创新在于预测层次结构内样本的关系，而不是操作单个样本。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/e7543877c08c47fbb783397ead04693a.jpeg" width="70%" />

</div>

更具体地说，我们使用一个简单的多层感知器（MLP），它接受样本对的表示作为输入，作为一个关系分类器。预测两只鸟的关系可以被视为一个封闭集分类问题，因为定义的系统发育树包括了所有专家鸟类物种。因此，通过将先前伪标记技术中的实例级预测目标替换为这种基于关系的预测，我们构建了一种新的基于关系的伪标记策略，重要的是为类别内和类别外数据提供了一个共同的标签空间。

我们进一步提出了两种新颖的策略，充分利用树状层次结构更好地对齐类别内和类别外样本。首先，我们重新利用了根三元组[27]的概念，并引入了一个三元组一致性机制来实现样本间的正则化（见图2中的根三元组示例）。我们推测，对于形成根三元组的任意三个未标记样本，其中恰好一个将与其他两个形成一致的关系（见图3(b)和第III-C2节的证明）。其次，在两个叶节点样本被标记的情况下，我们可以进一步推断未标记关系与真实关系的一致性（见图3(d)和第III-C4节）。通过这种我们称之为标签转移的策略，我们显著提高了学习到的伪关系的质量问题，进而有助于对齐。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/c3f8b8122fa1484cb0074684c0bc640c.jpeg" width="70%" />

</div>

我们在[15]发布的半监督FGVC基准数据集上进行了实验，这些数据集在传统设置和现实设置下进行了发布。与最先进的半监督和自监督方法相比，我们实现了更好或可比的性能。此外，我们展示了（i）所提出的框架可以以即插即用的方式轻松地与先前技术集成，进一步提高它们的表现，以及（ii）我们基于关系的方法是对类别外数据具有良好鲁棒性的，并且能够在从头开始训练时实现性能提升。消融研究进一步表明，我们的方法也可以与完全在我们的系统发育树之外的类别（例如，整个ImageNet[18]）一起工作。

# III. 方法论
## A. 概述
在本文中，我们专注于解决带有类别外数据的半监督细粒度分类挑战，提出了RelMatch。它由三个主要组件组成：特征提取器 $F(\cdot)$，类别预测器 $Pc(\cdot)$，和关系预测器 $Pr(\cdot, \cdot)$。然后我们可以使用 $Pc(F(\cdot))$ 进行单个样本的类别分类，以及 $Pr(Pc(F(\cdot)), Pc(F(\cdot)))$ 进行样本对的关系分类。与现有方法类似，RelMatch 同时使用标记数据和未标记数据进行学习。在训练阶段，每个批次都包含标记样本 $\{x_ i, y_ i\}_ {N_ i=1} \in X$ 和未标记样本 $\{u_ j\}_ {\mu N_ j=1} \in U$，其中 $y_ i$ 是真实标签， $\mu$ 是标记样本数量与未标记样本数量之间的比例。通常， $\mu > 1$ 以便更好地利用大量的未标记样本。在每次迭代中，RelMatch 使用三个损失进行优化：(i) 一个监督类别分类损失 $Lc$ 来优化 $F(\cdot)$ 和 $Pc(\cdot)$，(ii) 一个监督关系分类损失 $Lr$ 来优化 $Pr(\cdot, \cdot)$，以及 (iii) 一个无监督关系预测损失 $Lu$ 来优化 $F(\cdot)$ 和 $Pc(\cdot)$。然后总损失函数为：

$$
L_ {\text{total}} = L_ c + L_ r + L_ u
$$

具体来说， $L_ c$ 是一个标准的交叉熵损失：

$$
L_ c = -\frac{1}{N} \sum_ {i=1}^{N} y_ i \log(p_ {i, y_ i})
$$

其中 $p_ i = Pc(F(x_ i))$。 $L_ r$ 的细节在第 III-B 节中介绍。在第 III-C 节中，我们逐步介绍了 $L_ u$ 的三种变体，即 $L_ {u1}$、$L_ {u2}$ 和 $L_ {u3}$。


## B. 样本关系建模

1) **系统发育树**：如上所述，由于细粒度分类器的特征空间相对紧凑，类别外数据（其潜在标签完全超出训练标签空间）限制了之前SSL技术的效力。我们不是直接预测单个样本的类别，而是需要一个灵活的工具来容纳所有这些数据。遵循[26]中的标签层次结构，在本工作中，我们利用生物的系统发育树作为桥接类别内和类别外数据的工具。它可以被视为一个有根的树，其中不同分类级别的类别（例如，类、目、科、属和种）是具有不同深度的节点。之后，如图2所示，样本之间的关系可以在一个封闭集内离散定义（例如，“同科不同属”，“同属不同种”等）。这些关系可以用更公式化的方式表示。借鉴图论中的最低公共祖先（LCA）概念，对于一对具有类别标签 $y_ i$ 和 $y_ j$$ 的样本 $x_ i$ 和 $x_ j$$，它们的LCA可以表示为 $LCA(y_ i, y_ j)$。然后，这对样本的关系可以由它们LCA的深度 $Dep(LCA(y_ i, y_ j))$ 来表示。实际上，一对样本的LCA深度与它们在树上的路径距离成反比，可以被视为它们相似度的度量。在本文的后续部分中，我们让 $S(y_ i, y_ j) = Dep(LCA(y_ i, y_ j))$ 以简化表示。

2) **关系预测**：正如所强调的，RelMatch的目的是进行个体类别预测，所有关系预测的设计都应该服务于这一最终目标。因此，我们让关系预测器 $Pr(\cdot, \cdot)$ 接受来自 $Pc(\cdot)$ 的一对预测作为样本表示进行输入，这使得特征提取器 $F(\cdot)$ 和分类器 $Pc(\cdot)$ 都可以通过基于关系的监督进行优化。具体来说，设 $p = Pc(F(x))$ 为类别预测概率，其中 $p \in \mathbb{R}^C$ 且 $C$ 是类别的数量。然后，以 $p_ i$ 和 $p_ j$ 作为输入概率对，关系预测器首先使用向量外积来模拟它们逐元素的相关性作为 $m_ {i,j} = p_ i p_ j^T$， $m_ {i,j} \in \mathbb{R}^{C \times C}$。之后，将 $m_ {i,j}$ 向量化为 $vec(m_ {i,j}) \in \mathbb{R}^{C^2}$ 并与可学习的转换矩阵 $\theta_ t \in \mathbb{R}^{C^2 \times R}$ 相乘，再通过softmax函数获得最终的关系预测概率。预测结果 $r_ {i,j}$ 可以表示为：
$$
r_ {i,j} = Pr(Pc(F(x_ i)), Pc(F(x_ j))) = \text{Softmax}(vec(p_ i p_ j^T)^T \theta_ t),
$$
其中 $r_ {i,j} \in \mathbb{R}^R$ 且 $R$ 是离散关系的数目，等于系统发育树的深度。

3) 在训练阶段，我们简单地组合标记样本 $\{x_ i, y_ i\}_ {N_ i=1} \in X$ 和其反向版本在批次维度形成样本对集 $\{x_ i, y_ i, x_ {N-i}, y_ {N-i}\}_ {N_ i=1} \in B_ x$。有了系统发育树，我们可以直接通过找到物种标签的最低公共祖先来获得两个样本的真实关系，即 $s_ {i,j} = S(y_ i, y_ j)$，然后可以制定监督关系分类损失为：

$$
L_ r = -\frac{1}{N^2} \sum_ {i=1}^{N} \sum_ {j=1}^{N} w_ {s_ {i,j}} \times \log(r_ {i,j}, s_ {i,j}).
$$

请注意，当我们随机从系统发育树中采样对时，各种关系的发生概率显著不同，导致长尾分布。为了缓解这个问题，我们随机采样了训练集中的10,000个样本对，并计算了每种关系的发生概率。然后，我们将这个概率的逆标准化获得 ${w_ i}^{R}_ {i=1} \in W$ 并重新加权交叉熵损失。这里我们有 $\sum_ {i=1}^{R} w_ i = 1$。

## C. 通过关系预测进行伪标记
1) 朴素的关系基伪标记：有了成对关系的预测，我们可以简单地将之前SSL方法中的基于实例的预测（例如，伪标记[19]）替换为基于关系的预测（如图3(a)所示）。这似乎是一个直接但直观的解决方案，不仅使模型能够更好地从类别外数据中学习，而且还保持了以往技术的优点。对于基于关系的伪标记，优化目标可以形式化为：

$$
L_ {u1} = -\frac{1}{(\mu N)^2} \sum_ {j=1}^{\mu N} \sum_ {k=1}^{\mu N} \tau_ {j,k} \hat{w}_ {j,k} \log(r_ {j,k}, \hat{s}_ {j,k})
$$

其中我们采用具有最大预测概率的通道索引作为关系级伪标记，即 $\hat{s}_ {j,k} = \arg\max(r_ {j,k})$，并且 $\tau_ {j,k} = 1(\hat{s}_ {j,k} > t)$ 用于使用置信度阈值 $t$ 进行样本选择。

对于半监督学习，关键在于学习大量未标记数据的底层结构[46]。到目前为止，我们仅依赖于系统发育树来构建类别内和类别外数据共享的共同标签空间。在下一部分中，我们将更进一步，介绍细粒度类别的树状结构如何帮助我们实现更好的对齐。

2) 根三元组的一致性：根三元组是一个明显带有标签的、二元的、有根的、无序的树，具有三个叶子[27]（如图2所示）。算法研究人员已经很好地研究了，有了足够多的根三元组集合，可以重建包含它们所有的独特有根树[47]。对于任意属于有根系统发育树的叶子节点三元组 $\{A, B, C\}$，如果 $A$ 和 $B$ 的最低公共祖先（LCA）是 $A$ 和 $C$ 的LCA的适当后代，那么它们组成的子树就是一个根三元组。并且存在一个明显的一致性，即 $A$ 和 $C$ 的LCA也必须是 $B$ 和 $C$ 的LCA，可以表示为：
定理1：对于任意叶子节点三元组 $\{A, B, C\}$，使得 $\text{Depth}(\text{LCA}(A, B)) > \text{Depth}(\text{LCA}(A, C))$，我们有 $\text{LCA}(A, C) = \text{LCA}(B, C)$。

3) 通过三元组一致性的朴素一致性正则化：使用我们的符号，由定理1定义的三元组一致性可以表示为 $\forall \hat{s}_ {j,k} > \hat{s}_ {i,k}$，有 $r_ {i,k} = r_ {i,j}$（如图3(b)所示）。与之前仅依赖于单个样本一致性的一致性正则化方法不同，三元组一致性使得样本之间产生相互作用，例如 $r_ {i,k} = r_ {i,j}$ 表明模型对 $u_ j$ 和 $u_ k$ 的预测应该与模型对 $u_ i$ 的预测保持一致的关系。通过这种方式，我们也可以为无监督优化获得一个三元组一致性正则化（如图3(c)所示）：

$$
L_ {u2} = -\frac{1}{(\mu N)^3} \sum_ {i=1}^{\mu N} \sum_ {j=1}^{\mu N} \sum_ {k=1}^{\mu N} \tau_ {i,j,k} H(r_ {i,k}, \hat{s}_ {i,j})
$$

其中 $\tau_ {i,j,k} = 1((E_ {s_ {j,k}} \sim P_ {\hat{s}_ {j,k}} - E_ {s_ {i,k}} \sim P_ {\hat{s}_ {i,k}}) \geq 1)$ 作为样本选择的条件函数。 $E_ {s_ {i,k}} \sim P_ {\hat{s}_ {i,k}} = \sum_ {n=1}^{R} r_ {i,k,n} \times n$ 是 $s_ {i,k}$ 的数学期望，其中 $r_ {i,k,n}$ 表示样本 $x_ i$ 和 $u_ k$ 之间关系为 $n$ 的预测概率， $E_ {s_ {j,k}} \sim P_ {\hat{s}_ {j,k}}$ 同理。并且 $\hat{s}_ {i,j} = \arg\max(r_ {i,j})$， $H(\cdot, \cdot)$ 是用于距离测量的任意函数。当 $H(\cdot, \cdot)$ 以加权交叉熵形式 $H(r_ {i,k}, \hat{s}_ {i,j}) = w_ {\hat{i},j} \log(r_ {i,k}, \hat{s}_ {i,j})$ 出现时，即通过给予伪标记实现一致性正则化，它可以被视为通过引入样本间交互改进版本的(5)。

4) 通过三元组一致性进行标签转移：对于一个未标记的根三元组 $\{u_ i, u_ j, u_ k\}$ 使得 $\hat{s}_ {j,k} > \hat{s}_ {i,k}$， $\hat{s}_ {i,j}$ 是 $r_ {i,k}$ 的伪标记，因为 $r_ {i,k} = r_ {i,j}$。我们注意到，有了三元组一致性，伪标记的质量取决于关系预测 $\hat{s}_ {i,j}$ 和关系比较 $\hat{s}_ {j,k}$ 和 $\hat{s}_ {i,k}$ 的质量，这里仍有改进的空间。
为了接近最优解，即所提出的RelMatch，我们重新采样根三元组，包含两个标记样本和一个未标记样本作为 $\{x_ i, x_ j, u_ k\}$。然后，不是使用不可靠的预测，伪标记 $\hat{s}_ {i,j}$ 现在被真实标记 $s_ {i,j}$ 替换。一旦关系比较正确，就可以给出一个确切的伪标记。通过这种方式，三元组一致性的优势非常显著。这一切都是关于在标记数据和未标记数据之间建立桥梁——基于关系的标签可以从标记对转移到未标记对，通过一个简单的关系比较实现（如图3(d)所示）。最终，我们将生成伪标记的难度从多类分类问题降低到二类分类问题。我们通过标签转移进行无监督优化的目标是：

$$
L_ {u3} = -\frac{1}{\mu N^3} \sum_ {i=1}^{N} \sum_ {j=1}^{N} \sum_ {k=1}^{\mu N} \tau_ {i,j,k} w_ {s_ {i,j}} \log(r_ {i,k}, s_ {i,j})
$$

其中 $\tau_ {i,j,k} = 1((E_ {s_ {j,k}} \sim P_ {\hat{s}_ {j,k}} - E_ {s_ {i,k}} \sim P_ {\hat{s}_ {i,k}}) \geq 1)$ 作为样本选择的条件函数。

总结来说，RelMatch 可以被视为伪标记和一致性正则化的结合，具有 (i) 基于关系的伪标记而不是基于实例的伪标记，(ii) 样本间一致性正则化而不是样本内一致性正则化，以及 (iii) 通过标签转移生成伪标记而不是直接预测它们。


# IV. 实验结果与讨论
## A. 数据集
我们采用了两个半监督细粒度视觉分类（SSL-FGVC）基准数据集Semi-Aves和Semi-Fungi来进行比较实验和消融研究。每个数据集由三部分组成：标记样本 $(x_ i, y_ i) \in X$，类别内未标记样本 $u_ j \in U_ {in}$，这些样本与 $X$ 共享相同的标签空间，以及类别外未标记样本 $u_ k \in U_ {out}$，这些样本包含新颖但仍然属于系统发育树的类别。我们在实验中使用 $U_ {in} + U_ {out}$ 作为未标记数据，以模拟现实应用中我们无法确定未标记数据是类别内还是类别外的情况。为了与一般SSL工作保持一致，我们还保持了仅考虑 $U_ {in}$ 作为未标记数据进行无监督优化的设置。两个数据集的统计信息显示在表I中，Semi-Aves和Semi-Fungi的训练/验证/测试拆分设置分别是3,959/5,959/8,000和4,141/4,141/4,000。标签层级结构是根据维基百科上物种名称爬取的。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/6cdb21d5275d4caea7e7a756204da7de.jpeg" width="70%" />

</div>

## B. 基线方法
为了展示RelMatch的优越性，我们包括了以下方法作为比较的基线：

1. **香草监督基线**：模型仅使用标记数据 $X$ 和交叉熵损失进行训练。

2. **伪标记** [19]：按照[13]中的实现设置，标记数据和未标记数据以1:1的比例采样。

3. **MoCo** [48]：如[49]中所声称，自监督模型也可以是一个好的半监督学习器。由于计算资源有限，我们采用MoCo来训练图像编码器，因为它不依赖于大批量大小。整个训练过程包括在未标记数据上进行无监督预训练，然后对标记数据进行监督微调。

4. **FixMatch** [16]：FixMatch结合了伪标记和一致性正则化的思想。对于未标记数据，通过它们的弱增强版本给出伪标记，并用于监督它们的强增强版本。

5. **课程伪标记（CPL）** [20]：课程标记将模型训练分为多个阶段。在每个训练阶段，模型仅使用当前标记集以监督方式从头开始训练。在每个阶段之后，将一定比例的未标记样本（具有最高预测值）进行伪标记并添加到标记集中。整个训练过程将持续迭代，直到所有样本都被添加到标记集中。

6. **自训练** [15]："自训练"是一个广泛使用的术语，在[15]中特指基于知识蒸馏的程序。首先，使用仅标记数据 $X$ 训练一个普通的监督模型作为教师模型。然后，一个学生模型在标记数据和未标记数据上通过交叉熵损失进行监督。未标记数据的标签由教师模型的预测结果获得。

7. **FlexMatch** [17]：FlexMatch利用课程伪标记策略来解决FixMatch [16]中固定阈值带来的缺点。请注意，FlexMatch中的课程伪标记与CPL [20]不同，后者主要考虑不同类别的不同学习状态。

8. **ORCA** [44]：ORCA通过扩展分类头部来解决未标记数据中的新类别问题。之后，它采用成对相似性预测作为半监督优化目标，并使用自适应边界的交叉熵损失来控制已见类别的学习速度。结果，新类别可以顺利地分配到新添加的分类头部，模型可以以通用方式与它们一起工作。按照[44]的做法，ORCA通过自监督预训练进行初始化，本文中我们使用MoCo预训练权重对其进行初始化。

此外，[15]表明，组合各种SSL方法可以进一步提高性能。在本文中，我们还包括了**自训练 + MoCo**作为基线模型。

## C. 实施细节
为了公平比较，我们遵循了[15]中的实验设置。我们使用ResNet50 [51]作为所有实验的骨干网络。输入图像在训练期间随机调整大小并裁剪为224×224，在测试期间仅调整为224×224。我们使用SGD优化器，动量为0.9，并采用余弦学习率衰减计划[52]。为了与最先进的方法进行全面比较，我们从零开始训练RelMatch，以及使用ImageNet [18]预训练模型和iNaturalist 2018 (iNat) [53]预训练模型。注意，iNat是一个包含8142个物种的大规模细粒度数据集，与Semi-Aves和Semi-Fungi没有重叠。我们的模型对于从零开始和预训练模型分别训练了100k和50k次迭代，这与[15]中FixMatch的训练设置大致对齐。此外，学习率和权重衰减分别设置为{0.01, 0.001}用于从零开始的训练和{0.001, 0.0001}用于从预训练模型的训练。批量大小设置为32， $\mu = 10$。对于所有实验，我们展示了3次独立运行的平均值和标准差。

除了单独的RelMatch，我们还进行了RelMatch + MoCo和RelMatch + FixMatch的实验。它们的所有实现都与RelMatch保持一致，除了：(i) 对于RelMatch + MoCo，模型使用通过MoCo [48]在未标记数据上预训练的权重进行初始化，以及 (ii) 对于RelMatch + FixMatch，将FixMatch [16]的半监督损失函数添加到总损失 $L_ {\text{total}}$。

值得注意的是，在计算损失函数(4)-(7)时，遍历所有可能的对/三元组将导致计算成本呈指数增长。因此，我们在计算损失时不遍历每个样本组合——我们只确保每个标记/未标记样本都被遍历，并且从当前批次中随机采样其他样本来构建样本对/三元组。设 $DU(N_ 1, N_ 2)$ 为具有参数 $N_ 1$ 和 $N_ 2$ 的离散均匀分布，则(4)-(7)的实现如下。具体来说，我们还用算法1说明了(11)中 $L'_ {u3}$ 的计算。

$$L'_ {r} = -\frac{1}{N} \sum_ {i \in [1,N], j \sim DU(1,N)} w_ {s_ {i,j}} \times \log(r_ {i,j}, s_ {i,j})$$

$$L'_ {u1} = -\frac{1}{\mu N} \sum_ {j \in [1,\mu N], k \sim DU(1,\mu N)} \tau_ {j,k} \times \hat{w}_ {j,k} \times \log(r_ {j,k}, \hat{s}_ {j,k})$$

$$L'_ {u2} = -\frac{1}{\mu N} \sum_ {k \in [1,\mu N], i,j \sim DU(1,\mu N)} \tau_ {i,j,k} \times H(r_ {i,k}, \hat{s}_ {i,j})$$

$$L'_ {u3} = -\frac{1}{\mu N} \sum_ {k \in [1,\mu N], i,j \sim DU(1,N)} \tau_ {i,j,k} \times w_ {s_ {i,j}} \times \log(r_ {i,k}, s_ {i,j})$$


## D. 与SOTA方法的比较
我们在Semi-Aves和Semi-Fungi数据集上展示了与其他最先进方法的比较结果，分别在表II和表III中。当模型从头开始训练时，MoCo [48]展示了利用大量数据的巨大优势。它在Uin上取得了令人印象深刻的性能，并且随着Uout的参与进一步获得了提升。MoCo的有效性可能源于其动态样本队列和移动平均编码器，这有助于在有限的批量大小下包含更多的负样本。然而，其他半监督方法效果较差。与直接预测伪标记不同，所提出的RelMatch能够生成更可靠的伪标记而无需预训练。因此，我们在Uin上以较大优势超越了MoCo，并在两种设置下与MoCo结合使用时均获得了最佳性能。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/3068a4adcef84d33be9b585500e3c99a.jpeg" width="70%" />

</div>

在迁移学习的设置下，FixMatch [16]倾向于成为主导技术，尽管它将伪标记作为关键组成部分，并且在面对类别外未标记数据时注定会遭受性能下降。相比之下，Self-Training [15]对新类别更为鲁棒，尽管略有下降。相反，所提出的RelMatch可以单独在U_ out上轻松获得最先进的结果，并且在与MoCo和FixMatch结合使用时显著优于所有比较方法。

值得注意的是，在迁移学习的设置下，与FixMatch的实例基伪标记相比，所提出的关系基伪标记提供了一个更柔和的约束（例如，仅在粗粒度上约束样本，即特定的科，而不是在细粒度上，即物种），这在很大程度上支撑了其在U_ out上的优势。然而，有了U_ in，一个更柔和的正则化并不一定鼓励模型学习足够细粒度的特征。

一些观众可能会想知道为什么RelMath + FixMatch在Uin + Uout上的性能下降，甚至比单独使用RelMath时表现更差。这是因为尽管RelMath本身可以在Uin + Uout上表现良好，但它无法改变FixMatch的性质（单独的FixMatch在Semi-Aves上平均遭受了大约7.5%的性能下降）。毕竟，两个学习目标是独立工作的。然而，值得注意的是，在不同场景下，RelMath + FixMatch始终超越了单独使用FixMatch的性能。这确实突出了所提出的RelMath的价值和潜力。

总的来说，RelMatch的显著优点有三个方面：(i) 通过建立共享的标签空间并实现样本间一致性，RelMatch可以利用类别外数据挖掘有用的知识，(ii) 通过标签转移策略，RelMatch可以生成更可靠的伪标记，以及(iii) 作为更高级别的约束，RelMatch可以提供补充性的监督信号并提升以前的SSL技术。

## E. 消融研究

1) **不同关系基变体**：为了讨论关系基伪标记的各个组件的有效性，如表IV所示，我们对其变体进行了消融研究，这些变体在上一节中介绍过：(A) 关系基伪标记，(B) 三元组一致性正则化，以及 (C) 标签转移（RelMatch）。一个重要的发现是，所有这些关系基技术都成功地利用了类别外未标记数据，并克服了性能下降的问题。此外，通过引入三元组一致性正则化和标签转移策略，RelMatch在与朴素关系基伪标记相比时提供了更大的性能提升，这表明了样本间一致性和通过标签转移获得的可靠伪标记的优势，从而实现了更好的对齐。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/da0fd1a1e0be427ab1e9e912fe750849.jpeg" width="70%" />

</div>

2) **系统发育树的深度**：系统发育树在所提出的方法中起着最基础的作用。在本节中，我们对不同树深度进行了消融研究。注意，由于“Aves”和“Fungi”分别位于系统发育树的类级别和界级别，Aves树的深度为5，而Fungi树的深度为7。具体来说，我们逐步从叶子向根减少树的深度。所有提到的模型都是从头开始训练的。如表V所示，树深度的效果相对直接——随着利用的树结构变深，模型性能不断提升。这很容易理解，因为更深的树结构可以提供更细粒度的监督信息。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/f21af76949c24d1994c9d81e7d37d634.jpeg" width="70%" />

</div>

3) **训练迭代次数的影响**：为了更好地理解模型性能与训练迭代次数之间的关系，我们对迭代次数进行了实验，包括{1 K, 5 K, 10 K, 15 K, 20K}。如图4所示，对于从头开始训练的模型，我们可以得出结论，随着训练迭代次数的增加，模型性能不断提升，改进幅度逐渐减小。注意，随着迭代次数的增加，模型将更多地从大量的类别外数据中受益。对于使用预训练权重初始化的模型，它们可以在较少的迭代次数下实现良好的性能，但动态相似。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/dd397fa2151c4044935c9e04f76c24d9.jpeg" width="70%" />

</div>

## F. 讨论

1) **RelMatch如何提高伪标记质量？** RelMatch对类别外数据的有效性来自两个部分，即基于关系伪标记（即U vs U with label prediction）和标签转移策略（即X vs U with label transfer）。在本节中，我们通过实验验证了每一个部分的有效性。此外，由于使用标签转移需要样本对由一个标记样本和一个未标记样本组成，我们还包括了“X vs U with label prediction”进行比较，以证明标签转移带来的增益并不仅仅是由于改变了样本对的组成。由于原始的Semi-Aves和Semi-Fungi数据集没有未标记数据的类别标签，我们无法直接测量伪标记的质量。因此，为了回答这个问题，我们重新拆分了Semi-Aves和Semi-Fungi的标记集，以定量评估伪标记的质量。具体来说，我们将200个标记类别分成两半；然后我们将一半视为类别内类别（即Uin），另一半视为类别外类别（即Uout）。通过划分的类别，我们可以相应地拆分训练集和测试集。我们在类别内训练集上训练模型，然后分别在类别内（即Uin）和类别外（即Uin + Uout）测试集上进行测试。如表VI所示，当模型预测两个未标记样本的关系时，当出现类别外数据时，预测准确率仅下降了约5%，这为基于关系预测的优越性提供了坚实的证明。当预测标记和未标记数据之间的关系时，由于涉及标记数据时关系预测变得更容易，预测准确率自然提高。请注意，这只是标签转移的准备。当我们采用所提出的标签转移策略通过三元组一致性（即，伪关系从同一根三元组内的真实关系转移）时，预测准确率显著提高，类别内和类别外准确率之间的差距继续减小，这表明标签转移策略本身确实使伪标记更加可靠。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/d4bbdcdc8d8e4b4eacb7f54b8286bb02.jpeg" width="70%" />

</div>

2) **关系基伪标记在不同分类级别上的表现如何？** 为了观察每个分类级别上的伪标记质量，我们按照上一节的设置，重新拆分了Semi-Aves和Semi-Fungi的200个标记类别，以模拟类别内（Uin）和类别外（Uin + Uout）的情况。在表VII中，我们报告了每个分类级别的伪关系准确率。请注意，由于所有鸟类都属于同一个类“Aves”，因此Semi-Aves的结果从类级别开始。我们可以观察到，对于较粗的级别提供了更好的伪关系，而当涉及到更细的级别时，伪关系的质量很好度下降。这可能是因为粗级别拥有更显著的视觉特征和更多的训练关系样本。目前，我们通过加权交叉熵损失来解决关系分布的不平衡问题。然而，如何进一步提高细粒度级别的准确性仍然是未来的工作。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/7c9a129e596c41ffac397a2e77e7bf95.jpeg" width="70%" />

</div>

3) **学习到的树结构能否泛化到其他层次化数据？** 到目前为止，我们只验证了模型可以处理属于同一原始系统发育树Aves/Fungi的新类别。这里我们进一步探讨——学习到的树结构能否泛化到原始系统发育树之外的细粒度类别？为了回答这个问题，我们使用iNat [53]和ImageNet [18]数据集作为未标记数据进行了实验。更具体地说，我们使用了没有标签转移的RelMatch变体，即采用加权交叉熵损失的(6)用于SSL，而不是(7)。结果显示在表VIII中。有趣的是，这些数据集似乎确实有意义地贡献了性能提升，尽管与来自同一潜在树的未标记数据相比，提升幅度较小。我们认为这是因为所提出的关系基预测仍然可以作为其他层次化数据集的更高级别约束被利用。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/27d9fdfb9d2641e48063bc15809f2326.jpeg" width="70%" />

</div>

## G. 可视化
在这里，我们展示了模型如何预测样本对的关系，以及这些预测如何共同支持最终的类别预测。我们以Semi-Aves中的“鸟类”为例，并使用从头开始训练的模型以避免预训练知识的影响。应用Grad-CAM [54]生成激活图。

如图5所示，对于给定的锚定样本（最左边），我们首先选择5个与之展示不同关系的其他样本（例如，同一目不同科，同一科不同属等）。然后，我们为锚定样本及其上述相关样本在进行关系预测时可视化激活图。可以观察到，模型倾向于依赖不同的视觉线索与不同的样本相关联。例如，模型依赖于鸟类腿部区域的差异来判断“A. goliath”和“E. thula”属于同一科但不同属，并且它还学会了根据它们的喙部特征来区分“P. conspicillatus”和“A. goliath”，它们属于同一目但不同科。这与[26]中的结论相呼应，即不同粒度级别的分类依赖于不同的视觉特征，也表明模型可以通过预测不同的样本关系来学习多样的知识。
因此，在图5的最右列，我们在进行类别预测时重叠了关系预测期间的兴趣区域，以及最终的激活图。可以观察到，关系预测的大多数视觉线索确实支持了最终的类别级识别，这解释了模型如何从所提出的关系基半监督学习方案中受益。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/6ddc7d68073745729c8d29cdb1416f01.jpeg" width="70%" />

</div>

# V. 结论
在本文中，我们通过半监督学习的设置来解决细粒度视觉分类问题。我们的主要贡献在于如何最好地使用类别外数据进行训练。我们的解决方案依赖于利用细粒度类别的底层树状结构来构建基于关系的共同标签空间。我们进一步引入了三元组一致性正则化来帮助类别内和类别外数据的对齐。我们在半监督FGVC基准数据集上评估了所提出的方法，并报告了最先进的结果I

# 声名
本文内容为论文学习收获分享，受限于知识能力，本文对原文的理解可能存在偏差，最终内容以原论文为准备。  
本文信息旨在传播和交流学术，其内容由作者负责，不代表本号观点。文中内容如涉及作品文字。图片等内容、版权和其他问题，请及时与我们联系，我们将在第一时间删文处理。
