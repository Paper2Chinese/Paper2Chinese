# 题目：[Non-Smooth Trajectory Optimization for Wheeled Balancing Robots with Contact Switches and Impacts ](https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=10288547)  
## 非光滑轨迹优化：用于具有接触切换和冲击的轮式平衡机器人
**作者：Victor Klemm； Yvain de Viragh；  David Rohr；Roland Siegwart；Marco Tognon** 

****
# 摘要
近年来，轮式-腿式平衡机器人的能力稳步提高。然而，由于缺乏有效的控制算法来克服如楼梯等障碍，它们的使用仍受到严重限制。我们通过提出一种快速轨迹优化器，为生成能够克服一大类具有挑战性地形的轨迹迈出了重要一步。通过将底层建模限制在平面的非线性刚体动力学上，并将地形细分为接触阶段，我们获得了一个易处理的非线性规划问题。该模型显式地考虑了接触切换和冲击、牵引极限和驱动界限。通过引入与弧长相关的参数化，轨迹被固有地渲染为符合接触约束的。我们将该方法应用于轮式双足机器人Ascento的具体情况，为动力学方程导出了封闭形式的表达式，包括运动学环。为了跟踪轨迹，我们提出了一种简单的基于LQR的控制器。该方法在现实世界实验中得到了验证，我们展示了用于穿越台阶、驾驶上坡、跳跃、站立和驾驶上整个楼梯的轨迹的执行。据作者所知，通过轨迹优化使轮式-腿式机器人能够实现后者是一个新颖性。
# 关键词
- 腿式机器人
- 轮式机器人
- 优化与最优控制
- 接触建模

# I. 引言

多才多艺、快速且能效高的机器人，能够适应崎岖地形，将对从搜救到检查、巡逻和交付等一系列任务大有益。虽然纯腿部系统已被证明是一种可靠和稳健的解决方案[1]，但它们通常存在显著的速度限制和较高的运输成本，尤其是在携带有效载荷时。另一方面，纯轮式系统没有这些缺点[2]，但它们在崎岖地形上的适应能力相对较差。尽管存在解决方案，例如可变形的轮子[3]、类似漫游车的连杆机构[4]和履带[5]，但它们往往会严重损害系统的敏捷性和速度。有关节的轮腿式系统结合了两者的优点。例如，四足机器人ANYmal的轮式版本已经展示了令人印象深刻的运动能力[6]、[7]。关于其他四足轮腿机器人的综述，请参见[8]。这些四足实现的主要缺点是潜在的昂贵执行器数量和较大的占地面积。这些考虑使得平衡轮腿机器人成为吸引人的替代方案。事实上，除了研究[9]-[13]之外，这些系统也引起了工业界的显著兴趣[14]-[16]。然而，为了真正发挥它们的潜力并实现穿越典型人类环境的能力，需要适当的控制方法。关于轮腿平衡机器人的现有文献在这方面是不令人满意的，因为相应的控制方法在克服障碍物方面的能力非常有限。我们的工作通过提出一个明确考虑地形的轨迹优化（TO）方案，并在多个Ascento机器人的实验中进行验证，为填补这一空白迈出了重要一步（见图1）。本文提出的TO方案也比我们之前的方法[17]有显著改进，后者通过层次化全身控制来通过主动顺应处理不平坦和未知的地形。

在介绍Ascento机器人的初步工作中[11]，我们进一步展示了通过执行手工制作的跳跃程序来克服台阶的可能性。然而，由此产生的轨迹是显著次优的。可接受的台阶高度较低，可靠性较差，而且机器人在台阶前后需要相当大的空间来加速和减速，从而禁止了楼梯的穿越。本文提出的TO方案允许机器人克服这些限制，并跨越多种不同的地形，特别是整个标准楼梯（台阶高度为17厘米，台阶宽度为29厘米）。据作者所知，通过TO使轮腿机器人做到这一点是该领域的一个新突破。我们介绍了两个改进的Ascento原型机的实验。它们配备了比之前使用的机器人更强的电机和更大的轮子，使它们能够应对典型的城市环境。因此，我们的工作也展示了轮腿式平衡机器人确实是在我们日常环境中提供帮助的优秀候选者。

#### A. 问题描述和相关工作
轮腿式机器人的运动要求控制算法仔细利用系统动力学，在穿越具有挑战性的地形时保持平衡——电机扭矩有限，关节只有一定的运动范围，必须遵守牵引限制，且不应意外地接触或失去地面接触。此外，有时还希望系统轨迹在时间或能耗标准下是最优的。相应地，这些具有挑战性的运动任务不能以纯粹的反应方式解决，而是需要预见地形并规划未来的行动。明确这样做相当于基于模型的TO，这（可以说是）解决问题的最通用方法。基于包括环境在内的动力学模型，系统轨迹被优化，以遵守约束和/或最小化自定义目标函数。由于直观的物理描述，动力学参数的变化、地形的变化或目标函数的变化通常可以转化为问题表述的直接修改。此外，大量经过充分证明的数学工具可以应用于理论分析。然而，尽管理论上合理且直观，但在实践中解决优化问题很快就会变得难以处理，需要仔细设置问题，正如我们下面详细讨论的。或者，问题也可以通过使用数据驱动方法来解决，例如强化学习（RL）。这些方法最近作为经典控制技术的强大竞争对手出现了，并在（轮式）腿部机器人社区中找到了成功的应用。通过足够的训练数据和领域随机化，可以获得高性能和鲁棒的解决方案，其中一些似乎超出了经典TO的范围。然而，对它们的内部工作进行物理解释的困难，通常大量的训练（数据），以及如果系统参数、环境或目标发生变化，则可能需要重新训练，是可能的高性能的一些缺点。在以下段落中，我们首先提供当前基于模型的TO在状态艺术方面的概述，并确定我们试图填补的研究空白。为了将我们的工作置于数据驱动方法迅速扩展的能力的背景下，我们然后详细讨论它们的比较优势和各自的最新进展。可以将为腿部和轮腿机器人生成轨迹的一般问题视为一个无限维的最优控制问题，受到各种约束的限制。其中这些约束包括：1）非线性动力学方程，使问题成为非凸的。2）输入和状态的界限。这些包括纯状态约束，这些约束阻碍了将问题作为输入变量的问题来处理，例如，通过微分动态规划（DDP）。3）互补约束，假设硬接触，强制执行要么没有接触力，要么接触面法线速度为零。后者表明问题的固有组合性质，以及随着时间范围呈指数增长的计算复杂性，以找到全局最优解。此外，众所周知，互补约束不满足线性独立性约束资格（LICQ），因为它们在与Karush-Kuhn-Tucker（KKT）条件相关的方程组中引起秩损失（例如，见[18]）。这不仅从分析/理论的角度使问题复杂化，而且还需要在数值求解器方面特别小心。此外，非平滑地形引入了另一个数学上密切相关的复杂性。它使得大多数传统的模拟和控制轮式（倒立摆）系统的方法——例如[19]，[20]——不适合我们的目的，因为在底层建模中假设了平滑地形。希望了解更多关于非平滑力学主题及其复杂性的信息的读者，可以参考经典著作，如[21]，[22]。简而言之，即使仅寻求局部最优解，问题通常也远非平凡。这也得到了经验证据的支持。所有我们知道的尝试以一般性建模问题的优化方法，即使用完整的刚体动力学模型和互补约束，要么没有说明求解器的计算时间，要么报告的收敛时间是以分钟到小时计的，对于时间范围在几秒钟的轨迹[23]-[29]。而且，除了最后一个，所有这些工作都限制在平面机器人模型上。不足为奇的是，大多数出版物——包括本文——通过权衡一般性、可接受运动范围、局部最优性或物理精度以换取收敛速度来解决这些困难。对于纯腿部机器人，这些方法的范围从围绕参考轨迹线性化的系统模型解决问题[30]，诉诸于软接触模型[31]，采用简化动力学模型，其中腿部被视为无质量和预定接触时机的[32]-[36]，到应用以零力矩点概念为中心的基于启发式的方案[38]，[39]。在这些工作中，地形大多被假设为平坦的。关于纯粹腿部机器人的工作[40]，[41]在这方面是一个例外，并且由于与我们方法的概念关系密切，值得特别关注。也就是说，它们建立在基于阶段的参数化上，其中接触开关的数量是预先确定的，但是接触时机——或者换句话说，接触阶段的长度——是优化的。与使用互补约束的方法相比，后者可能等价地被写成整数规划问题，这种方法具有显著的优势，导致形成常规的非线性规划（NLP）问题，该问题满足LICQ。对基于阶段的问题表述的理论更详细的处理感兴趣的读者，可以参考处理混合系统切换时间优化的作品，例如[42]。前面的几个段落的推理表明，轮腿系统的TO问题至少与纯腿部系统的问题一样困难，因为必须控制接触点的额外自由度（DOFs），并且必须遵守相应的非完整约束。实际上，那些展示复杂运动的作品，如混合驱动和步进，采用了严重的简化——类似于那些为纯腿部系统提到的——以实现合理的计算时间[6]，[7]，[43]-[49]。在这些作品中，只有[7]，[48]，[49]明确考虑了地形，而后面两者仅限于纯驾驶。最近发表的工作[7]（类似于[48]）基于阶段方法[40]，并通过放宽与地面接触的脚的零速度约束来扩展到轮式系统，允许沿着躯干朝向方向和垂直于地形法线的运动。这与我们的工作采用的基于弧的最小状态表示形成了鲜明对比，后者在本质上与接触约束一致。另一个重要的不同是我们选择的机器人由3D浮基和点脚/轮子近似，而我们采用了完整刚体动力学的平面版本。我们的选择是基于这样的观察：在零侧倾的温和假设下，所选平面在局部上与轮腿平衡机器人的通常主要操作方向（步行横向通常不可能）相匹配。也就是说，平面与驾驶和平衡的方向对齐。因此，我们认为，为了提高平面建模的准确性而牺牲三维模型的一般性，在许多方面是一个明智的选择。然而，对于像[50]-[52]这样的漫游车系统，采用了不同的克服具有挑战性的地形的方法。在这些情况下，优化以静态方式解决接触力，而不进行任何TO，这使得这种方法不适用于平衡系统。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/b7a48e3fccb3465a86ee61b6169cef78.png)


将我们的注意力转向轮腿平衡机器人的具体案例，我们观察到最近的典型方法通常依赖于修改后的瞬时反馈律，例如LQR，这些通常与层次优化结合使用，用于上半身的任务空间控制[11]，[13]，[17]，[53]-[55]。尽管存在一些TO方法，但它们要么在优化中省略了接触开关的模型[56]，要么为特定运动（如跳跃）开发[12]，[57]。不幸的是，关于波士顿动力公司的Handle机器人的控制方法知之甚少[14]，[15]，这些机器人展示了令人印象深刻的性能。总之，关于轮腿机器人的基于模型的TO主题，在文献中仅被边缘探索。问题的数学性质使其成为一个具有挑战性的问题，现有的方法要么收敛时间差，要么假设非常有限，或者专门针对四足动物而不是平衡机器人。我们的工作试图弥补轮腿平衡机器人的研究空白。现在，我们将注意力转向数据驱动方法，如强化学习。尽管缺乏理论保证，但最近的结果控制器已经展示了前所未有的鲁棒性。也就是说，它们在防止机器人摔倒方面非常有效，无论是对于纯腿部[58]-[60]还是轮腿的[61]-[65]。这些控制器还证明了处理和利用复杂接触场景的能力，其中不仅脚与地面接触，而且膝盖和躯干等部位也接触[66]。其中一些运动目前似乎无法通过计算上可行的基于模型的TO方案达到。另一方面，当涉及到穿越未知地形，需要提前规划，并且必须正确利用系统动力学时，基于模型的TO[32]，[33]和RL[67]方法最近都展示了越来越令人满意的性能，至少对于四足动物系统的情况是这样。尽管基于RL的方法的性能和多功能性正在稳步提高，但生成更长、更复杂的运动仍然是一个挑战。主要困难通常可以被认为是找到一种结构化的方式来探索解决方案空间。这尤其适用于依赖于基于抽样的零阶梯度估计的常见RL方法。相比之下，TO方法可以以显著的样本效率来解决这些问题，使它们作为数据生成器也非常有价值，可以通过为复杂运动的探索提供指导来大大加速RL训练。

#### B. 贡献和概述
我们的主要贡献是为轮腿平衡机器人在不平坦地形上的运动提出了一个通用的TO方案。其性能和新颖性特别（但不限于）来自于以下特点的结合：
• 将TO限制在平面非线性刚体动力学上，以降低问题维度并获得可处理的模型（第II节）。
• 将地形细分为接触阶段，从而避免了典型模式调度问题的离散性质和指数复杂性（第II-A节）。
• 与弧长相关的轮状态参数化，允许在运动学上固有约束一致的子空间内表述接触阶段的动力学（第II-B节）。
• 通过将动力学重新投影到完整空间中，明确表述接触力约束和冲击性冲击（第II-C节和II-D节）。
• 转录为可以在几秒钟内由常规求解器解决的NLP。所选择的公式允许在没有条件语句的情况下使用自动微分（第III节）。
• 我们提出了一种自定义的Hermite-Simpson Collocation方案的增强，它提供了改进的精度，而不需要额外的函数评估。它适用于广义速度是广义坐标时间导数的系统（第III-C节）。此外，作为对Ascento机器人应用的一部分，我们的贡献包括：
• 我们展示了如何导出Ascento运动学循环的解析表达式，这些表达式是封闭形式的，并且在整个操作范围内有效。这使我们能够获得平滑可微的动力学方程（第IV-A节）。
• 我们提出了一个简单直观的高增益PD控制器，用于跟踪轨迹并稳定系统，使其保持在由平面建模良好近似的动力学区域内。为了更好地考虑非最小相位平衡动力学，其增益部分是从LQR中选择的（第IV-B节）。
• 我们讨论了与状态估计、系统识别和硬件相关的选择，这些选择对于成功的现实世界部署是重要的（第IV-C节）。像许多相关的TO工作一样，例如[7]，[40]，[41]，[48]，[49]，我们假设给定了地形图。这留下了一些关于我们方法在不太理想条件下性能的未解决问题。因此，在第V节的模拟和实验中，我们提供了对故障地形映射的鲁棒性的初步评估，这也模拟了接触时机不匹配的情况。对这方面的更全面评估将需要大量的额外测试，因此留给未来的工作。我们在第VI节讨论了进一步有希望的研究和扩展方向。

## II. 建模
正如第I-A节所概述的，适当的系统建模对于在合理的时间内计算解决方案至关重要。因此，本节重点介绍了与地形相关的动力学方程的公式和参数化，因为它们是复杂性的主要驱动因素。我们建模中可能最具限制性的选择是将系统视为平面。所选平面与驾驶和平衡的方向对齐，如图2所示。粗略地说，对于典型的（双足的）轮腿平衡机器人，这个平面匹配了主要操作方向，构成了机械设计的对称平面，并且是最具挑战性的动态控制平面——它们是不稳定的和非最小相位的。正如我们在Ascento的实验中所展示的，离平面动力学可以通过高增益跟踪控制器很好地调节。这使得平面建模成为一个不错的近似。因此，我们认为在许多方面优先考虑平面建模的准确性而不是三维模型的一般性是一个明智的选择。这种选择大大降低了动力学方程和约束的复杂性，通过消除诸如陀螺效应、空间摩擦和可能的秩不足地面接触等，可以在不进行任何简化的情况下完全非线性地建模平面刚体动力学，而且即使对于长时间范围，我们的TO方案的计算时间仍然在几秒钟的范围内。本节的其余部分详细说明了平面建模。首先，我们解释了如何从平面地形横截面获得接触阶段和位置（第II-A节）。然后，我们展示了如何从一组广义坐标导出刚体动力学，其中对于车轮采用了最小的、与弧长相关的参数化（第II-B节）。最后，我们讨论了如何通过从约束一致空间重新投影来考虑对地反作用力的约束和对冲击性过渡的处理（第II-C节和第II-D节）。

### A. 地形阶段生成
假设给定了一个即将到来的平面地形横截面，并假设在以下推导中始终保持与地面的接触（我们将在第III-H节中放宽这一假设）。我们定义了一个惯性参考框架I，其z轴相对于重力指向上方，见图2。我们的方法从将地形细分为——或将其近似为——一个有序集合T的相邻曲线段ci开始，这些曲线段描述了地形高度作为x坐标的函数，并且假定在其有界域上至少是三次连续可微的。即，
T = {c1, ..., cNc}，对于每个ci(x) ∈ C3，定义域为xmin,i ≤ x ≤ xmax,i，
其中[xmin,i, xmax,i]是第i个曲线段的定义域。这允许我们模拟几乎所有感兴趣的刚性地形，因为只要求不连续性的数量是有限的。特别是，包括台阶和楼梯在内的非平滑地形也可以被建模。基于这种细分，我们通过一个过程来构建接触阶段，在这些阶段中，轮式系统的动力学表现出平滑的特性。从直观上讲，这相当于滚动一个半径为r的轮子越过地形并追踪其中心点m，见图2。对于给定的地形部分，这相当于应用变换

$$
m_i(x) = \begin{bmatrix} x \\ c_i(x) \end{bmatrix} + r \frac{1}{\sqrt{1 + c_i'(x)^2}} \begin{bmatrix} -c_i'(x) \\ 1 \end{bmatrix},
$$

其中c'i表示ci关于x的导数。然而，由此得到的曲线段mi可能是重叠的或者在x坐标上是不连续的。正如图2所示，某些段被缩短了（例如，m1和m2在它们相遇的点），并且引入了额外的段（例如，m3）以获得一个连接的中点曲线。因此，x坐标不适合作为中点曲线的参数，我们用一个密切相关的标量参数s来替换它。从某种意义上说，s可以被认为是在适当的位置添加、移动、扭曲和移除x的定义域的补丁。我们将s称为弧参数，因为它与曲线m的弧长密切相关。选择s而不是直接使用弧长的原因——尽管它具有直接的物理解释——是后者会过度限制我们能够用封闭形式表达的段类型，例如阶数≥2的多项式。现在，让我们更详细地考虑两个问题案例：相交和不连续的段（下面提供的示例参考图2）：

当两个相邻的段mi和mi+1在它们的定义域内部相交时（例如，m1和m2），必须相应地缩小域。交点可以通过解析计算或使用梯度下降等数值计算技术来确定。此外，我们注意到，由此产生的整体轮中心曲线m在交点处可能表现出一个尖点，导致车轮运动的瞬时方向变化，从而对系统产生冲击。
否则，如果端点不重合（这对应于不连续性），则至少必须插入一个额外的段。正如台阶的例子所示，当车轮的中点到达边缘时，它会沿着一个圆弧轨迹移动（考虑从c2到c3的过渡以及相应的段m3）。然后可以区分两个子情况。要么，相邻地形段的高度差小于或等于车轮半径，在这种情况下，引入圆形段就足够了（如从c2到c3的过渡）。或者，高度差大于车轮半径，在这种情况下，必须插入第二个垂直段（如从c3到c4的过渡，其中需要一个垂直段m5和一个圆形段m6）。在这两种子情况下，额外的段和相邻的处理方式与情况1相同。地形部分的曲率等于或小于车轮半径时可能会引起的一个额外的复杂性（如在c4的中间发生的情况）。然后，车轮不能平稳地滚过地形，相应的中点曲线必须分成两部分，其中连接部分的处理方式与情况1相同。类似的情况是，当两个角落之间的距离小于车轮半径，以至于车轮无法触及它们之间的一小块地形时（如地形段c5）。然后，我们可以简单地移除相应的地形部分，并按情况2继续进行。我们参数化的不可避免的后果是，s的时间导数在相邻段之间的过渡处可能是不连续的。我们强调，这与地形是否表现出不连续性或尖点无关——这是一个数学现象。在接下来的部分，我们将这些不连续性称为虚拟冲击，因为它们只影响参数化而不是系统动力学（见第II-D节的末尾）。总之，该过程产生了Nm个平面参数曲线mi，每个曲线在其定义的有界域上都是两次连续可微的，即{m1, ..., mNm}，它们构成了曲线m。在这些接触阶段的每一个中，系统的动力学都是平滑的，因此是连续可微的。我们方法的重要性在于，通过定义接触阶段，问题中困难的组合性质被降低为必须找到有序集合的最优持续时间的相对简单得多的任务。关于TO，我们注意到，虽然我们的方法预定了不同地形段通过的顺序，但它并不限制在段内的运动方向。对于轮式平衡系统来说，这一点尤其重要，因为它们的非最小相位动力学意味着，为了向一个方向移动，可能首先需要向相反方向移动。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/7d8dd29ca8f3402c9a2e569d87d54f9c.png)

### B. 系统动力学

在前一节介绍的地形的基础上，我们接下来推导轮式平衡机器人的动力学。我们假设该系统为一个平面系统，由一个随意的连接机制和一个固定在轮子上的杆（我们称之为桩）组成。轮子和地面之间的接触交互在我们的方法中起到了中心作用，我们采用了以轮为中心的参数化方法，这对于代数表达非常有利。具体来说，我们定义系统的广义坐标为：

$$
q_r = [x \quad z \quad \phi \quad \theta_1 \quad ... \quad \theta_{N_f}]^T,
$$

其中， $x$ 和 $z$ 表示轮子的笛卡尔坐标， $\phi$ 表示轮子的角度， $\theta_i$ 表示上层结构的任意设计可能的角度。桩的动作由已知的一组参数化的广义坐标 $y_j, j = 1, \ldots, N_f$ 描述。系统的整体状态向量定义为 $q_r^T = [q_r^T \quad \tau_r^T]$，其中 $\tau_r$ 表示驱动系统的向量输入，例如扭矩。

采用拉格朗日力学形式，动力学方程可以推导如下：

$$
M_f(q_r) \ddot{q}_r - h_r (q_r, \dot{q}_r) = S_f^T \tau_r + J^T \lambda_c, 
$$

其中 $M_f$ 表示对称的正定质量矩阵， $h_r$ 包含剩余的惯性力、重力等， $S_f$ 是选择矩阵，映射作用力到它们各自的自由度，而 $J$ 是接触雅可比矩阵， $\lambda_c$ 是接触力，我们将在后续讨论地面接触力。

为了压缩表达式，我们定义了最小状态向量 $x_s = [q_r^T \quad \dot{q}_r^T]^T$。我们接下来找到从 $q_s$ 到广义坐标 $q_r$ 的变换映射以及从变换映射到它们的一阶和二阶导数的映射。这些变换将原始的动力学方程 (2) 映射到约束一致的子空间。

通过这些变换，我们得到了轮子中心的轨迹为 $x$ 和 $z$ 的函数 $m(s)$，并且有：

$$
\phi_T = \int_0^s \ell m'(\tau) d\tau, 
$$

其中 $m'(s) = \frac{dm}{ds}(s)$。由此我们获得了从 $q_s$ 到 $q_r$ 的变换映射。

转换映射 $q_s$ 到 $\dot{q}_ r$ 通过对 $f_{q_s}(q_s)$ 的微分得到，即：

$$
\dot{q}_ r = \frac{d}{dt} f_{q_s}(q_s) = Q_s \dot{q}_s,
$$

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/dcaf233719bf445abe1efa995de63795.png)


其中 $Q_s$ 是从 $f_{q_s}(q_s)$ 的雅可比矩阵。在雅可比矩阵 $Q_s$ 和它的时间导数的基础上，动力学方程 (2) 的投影形式为：

$$
M_s \ddot{q}_s - h_s = S_f^T \tau_r, 
$$

其中 $M_s = Q_s^T M_f Q_s$, $h_s = Q_s^T (h_r - M_f Q_s \dot{q}_s)$。在这里，重要的是，通过虚功原理，接触力的投影消失，因此动力学和运动学是一致的。

最终，我们定义了时间导数的最小状态向量，即 $\dot{x}_s$，这为实时计算提供了方便：

$$
\dot{x}_ s = f_ {q_ s}(q_ s, \dot{q}_ s, \tau_ r)
$$

**备注**：现在我们回到选择运动学方法的原因。在动态方法中，约束力通过在加速度级别施加零速度约束来解决【70】。这种方法通常会经历显著的约束漂移，必须通过诸如Baumgarte稳定化方法【71】等措施来对抗。由此产生的公式往往很僵硬，可能包含非平滑切换，这对基于梯度的轨迹优化（TO）可能造成问题。即使采用小的积分步长，一定量的地形穿透也是不可避免的，当不同的接触在短时间内连续激活时，如在台阶情况下，这种情况会加剧。由于穿透和约束漂移可能显著改变接触调度，我们认为动态方法不利于我们的目的。

使用最小表示法的替代选项可以是显式引入运动学约束或使用微分代数方程（DAE）积分技术（与前者密切相关）。我们避免使用前者，因为它会在优化中引入额外的约束，也避免使用后者以降低计算复杂性。最后，我们注意到，在并联运动系统中处理环闭合约束时，这两种方法都有使用。然而，相应的约束通常是双边的，因此涉及较少。

有兴趣的读者可以参考【17】了解动态方法，以及第IV-A节了解运动学方法。
### C. 接触力约束

在前一小节中引入的最小坐标公式将接触约束建模为双向的，因此允许拉力——并隐含地将地面视为具有任意大的摩擦系数（这些假设对应于完美滚动）。因此，接触力 $\lambda_C$ 必须相应地通过TO中的（单边）摩擦锥约束来约束，详见第III-D节。然而，尽管使用最小坐标表示，这些力的访问权限已丢失，必须通过重新投影到广义坐标 $q_f$ 对应的空间来恢复它们。

这是通过确定 $q_f$ 及其导数的关系（4）、（5）、（7）来完成的，然后通过评估以下公式求解接触力：

$$ 
\lambda_C = (J_C M_f^{-1} J_C^\top)^{-1} (J_C M_f^{-1} (h_f - S_f^\top \tau) - \dot{J}_C \dot{q}_f ). 
$$

上述表达式是通过注意到，对于完美滚动，当前与地面接触的轮子点 $C$ 的速度必须为零得到的。即， $v_C = J_C \dot{q}_f = 0$，从中可以通过时间微分得到加速度级别的约束：

$$J_C \dot{q}_f + J_C \ddot{q}_f = 0.$$

将此约束与EOM（2）结合，给出了 $\lambda_C$ 的期望表达式。我们注意到使用（4）和（5）可以用最小表示来表达它。

为了完整性，我们注意到接触雅可比为：

$$J_C = [ I -r t(s) 0 ],$$

其中 $t(s)$ 是轮子在 $C$ 处的（标准化的）切向量， $I$ 表示单位矩阵。轮子在 $C$ 处的切向量和法向量可以从轮中心曲线得到：

$$t(s) = \frac{m'(s)}{\|m'(s)\|}, \quad n(s) = \frac{1}{\|m'(s)\|} \begin{bmatrix} -m_2'(s) \\ m_1'(s) \end{bmatrix},$$

分别是，其中 $m_1(s)$ 和 $m_2(s)$ 分别是 $m(s)$ 的 $x$ 和 $z$ 组件。由于我们是相对于轮子而非地形来定义这些量，即使地形有不平处，它们也总是定义明确的。

为了制定牵引力约束和非负约束，将接触力表达在与切向量和法向量对齐的框架 $C$ 中是方便的：

$$C\lambda_C = R_{IC} \lambda_C, \quad R_{IC} = [t(s) n(s)],$$

其中 $R_{IC}$ 是 $R_C$，其中 $R_C = [t(s) n(s)]$。

我们将在后面用到 $C\lambda_C$ 的切向分量和法向分量，分别称为 $\lambda_T$ 和 $\lambda_N$。

### D. 冲击相位转换

事实上，将我们的建模扩展以处理冲击相位转换是相当直接的，例如在跳跃时发生的情况，这在第III-H节中有讨论。为此，我们必须关联冲击前的速度 $\dot{q}^-$ 和冲击后的速度 $\dot{q}^+$ ——即速度在冲击事件时的左右极限。这再次通过重新投影到广义坐标 $q_f$ 对应的空间来完成，其中冲击前和后速度的关系如下所给出：

$$\dot{q}^+ = N \dot{q}^- \quad \text{和} \quad N = I - M_f^{-1} J_C^\top (J_C M_f^{-1} J_C^\top)^{-1} J_C.$$

可以通过注意到将EOM（2）在单一时间实例 $t_0$ 积分的情况下得到此关系，对于冲击案例，产生了下面的方程：

$$\int_{t_0} (M_f \ddot{q}_f - h_f - S_f^\top \tau - J_C^\top \lambda_C) dt = M_f (\dot{q}^+ - \dot{q}^-) - J_C^\top \tilde{\lambda}_C = 0,$$

其中 $\lambda_C$ 是冲击接触力， $J_C$ 是与冲击后相位对应的接触雅可比矩阵。假设冲击后完美滚动， $J_C \dot{q}^+ = 0$，可用于消除 $\tilde{\lambda}_C$。即，如果将上述方程先乘以 $M_f^{-1}$ 再乘以 $J_C$，冲击后速度 $\dot{q}^+$ 被消除，然后可以将 $\tilde{\lambda}_C$ 表达为 $\dot{q}^-$ 的函数，进而得到所需的表达式（13）。

我们注意到在非冲击转换的情况下，该方案也适用。在II-A节中，对于非冲击转换，投影（13）将产生 $\dot{q}^+ = \dot{q}^-$。换句话说，（13）适用于所有转换。然而，对于非冲击转换，冲击投影器 $N$ 并非简单的单位矩阵；相反， $\dot{q}^-$ 位于 $(N - I)$ 的零空间中。

对于冲击约束的数值实现，一个重要考虑是，作为 $\dot{q}_s$函数的约束是秩亏的。即， $\dot{x}$、 $\dot{z}$、 $\dot{\phi}$都可以表示为 $s$（和 $\dot{s}$）的函数。由于 $\dot{\phi}$和 $s$之间的映射（6）总是良好定义的，我们因此可以简单地丢弃对 $\dot{x}$和 $\dot{z}$的约束部分。这可以解释为回投影到对应于 $\dot{q}_s$的空间。

因此，一个将 $\dot{q}_f$转换为 $\dot{q}_s$的转换映射给出如下：

 $$f_a(s, \dot{q}_f) = \begin{bmatrix} 0 & 0 & \frac{m'(s)}{\|m'(s)\|} & 0 \\ 0 & 0 & 0 & 1 \end{bmatrix} \dot{q}_f.$$

因此，相邻接触相位的冲击方程为：

 $$\dot{q}_s^+ = f_a(s^-, N \dot{q}_f^-).$$

### III. 轨迹优化

本节详细介绍了我们的TO方案的NLP公式化。其基本结构如图4所示。

我们设定该方案是无冲突的，唯一的预期调整参数是最大总轨迹时间 $T_{\text{max}}$，用以调整动作的激进性。然而，需要注意的是，增加收敛时间可能在某种程度上提高了非凸优化问题的表述难度，可能需要修改常规的求解方法。即，求解器可能会被视为通过修改公式内部约束来间接调整优化设置。使用内点法，如我们建议的，隐含地引入了一个惩罚接近不等式约束边界的成本函数。我们将在第V-A节讨论求解器和优化设置的选择。

### A. 优化变量

由于我们强制执行一系列纯状态约束，我们选择直接转录方法，该方法同时优化状态和输入。我们将相位持续时间 $\Delta T_i$ 作为优化变量包括进来，并假定预先确定的持续时间会通常导致次优的解决方案——因为它们需要系统加速或减速，可能甚至使得一个原本良好的问题变得不可解。

我们通过将每个相位的持续时间 $\Delta T_i$ 分割成等间隔的持续时间 $N_{k_i}$ 节点来离散化时间，从而覆盖每个相位的终点时间和相邻相位的起始时间。这为冲击转换阶段的制定提供了便利，详见第III-F节。对于每个阶段，我们在两个矩阵中收集状态和输入变量：

$$
X_i = \begin{bmatrix} q_{s,i,1} & \ldots & q_{s,i,N_{k_i}} \\
                     \dot{q}_ {s,i,1} & \ldots & \dot{q}_ {s,i,N_{k_i}} \end{bmatrix},
U_i = \begin{bmatrix} \tau_{i,1} & \ldots & \tau_{i,N_{k_i}} \end{bmatrix}.
$$

这样可以紧凑地制定与系统动力学相关的约束，因为这些在一个阶段内是不变的。

### B. 边界条件

我们限制初始状态 $X(0)$ 与初始状态 $x_{0}$ 对应，末状态 $X(T)$ 对应于最终状态 $x_{T}$。我们注意到在某些情况下，期望设置一个稳态解作为最终状态可能是有利的。在这种情况下，可以合理地添加相应的输入约束 $U(T) = u_{T}$，其中 $u_{T}$ 是稳态输入。此外，每个相位的持续时间 $\Delta T_i$ 应为正，我们要求轨迹的总持续时间固定为一个预设值 $\Delta T_{\text{max}}$，作为调整参数。

### C. 系统动力学

我们在第II-B节中推导出的动力学模型融入了一种定制的Hermite-Simpson搭配方案，我们依赖这种方案因为它代表了一个“甜点”，即功能评估数量的最优点。在标准的Hermite-Simpson方法中，使用由三次多项式和输入的线性函数来提供第三阶精度，只需两次函数评估。我们在后面展示如何扩展该方法以生成在其他精确性要求下的解决方案。相关详细信息请参见附录A。

将Hermite-Simpson配点方案应用于二阶动力学系统（隐式地）需要两组三次多项式——一组用于广义坐标的插值，另一组用于广义速度的插值。然而，即使广义速度仅仅是广义坐标的时间导数——就像我们的情况一样，这仍然会导致两者之间的运动学不一致。我们通过使用四次多项式来插值广义坐标来解决这个问题，这些四次多项式是从用于插值广义速度的三次多项式积分得到的。结果是广义坐标的精度达到四阶，因为坐标多项式的导数与速度多项式匹配，后者提供了三阶精度。正如我们所展示的，这并不需要在每个离散化区间内额外进行函数评估。

给定两个相邻节点点A和B，中心配置点C位于中间位置——见图5——扩展方案如下所述。由于这些陈述一般成立，我们省略了阶段和参数化特定的索引。首先，通过动力学表达式（参见方程（11）），节点点的加速度被表达为：

$$\ddot{q}_ A = f_{j_A}(q_A, \dot{q}_ A, \tau_ A), \quad \ddot{q}_ B = f_{j_B}(q_B, \dot{q}_B, \tau_B).$$

然后，通过插值公式（参见附录A中的推导）得到中心配置点的相关量：

$$ q_C = \frac{\Delta t}{32}(13 \dot{q}_A + 3 \dot{q}_B) + \frac{\Delta t^2}{192}(11 \ddot{q}_A - 5 \ddot{q}_B) + q_A, $$

$$ \dot{q}_C = \frac{1}{2}(\dot{q}_A + \dot{q}_B) + \frac{\Delta t}{8}(\ddot{q}_A - \ddot{q}_B), $$

$$ \ddot{q}_C = -\frac{3}{2 \Delta t}(\dot{q}_A - \dot{q}_B) - \frac{1}{4}(\ddot{q}_A + \ddot{q}_B), $$

$$ \tau_C = \frac{1}{2}(\tau_A + \tau_B), $$

其中 $\Delta t$ 是通过将当前相位持续时间 $\Delta T$ 划分为 $N_k$ 个等间隔的配置点间隔获得的离散化间隔。最后，这些表达式被组合成以下两个约束：

$$ \ddot{q}_C = f_j(q_C, \dot{q}_C, \tau_C), $$

$$ q_B = \frac{\Delta t}{2}(\dot{q}_A + \dot{q}_B) + \frac{\Delta t^2}{12}(\ddot{q}_A - \ddot{q}_B) + q_A. $$


这些是微分法——第一个约束——和积分法——第二个约束——的混合体。对于整个阶段，这些约束可以（在轻微的符号弯曲下）被汇集为： $\dot{X}_ i = f_{x_i}(X_i, U_i)$。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/233d0c34ffb64647a390ed35f4cf6381.png)

### D. 摩擦锥

如在II-C节所讨论的，II-B节的动力学建模需要通过摩擦锥约束来补充。假设 $\mu$ 表示静摩擦系数，这些约束给出如下：

$$ \lambda_{N}(x_{s,i}, \tau_i) \geq 0, \quad |\lambda_{T}(x_{s,i}, \tau_i)| \leq \mu \lambda_{N}(x_{s,i}, \tau_i). $$

对于整个阶段，这些可以被写成（轻微滥用符号）作为集合约束：

$$ \mathcal{C}_i(X_i, U_i) \subseteq F_j(X_i, U_i, \mu). $$

### E. 状态界限

在给定阶段内，弧参数 $s$ 必须受到对应起始和结束值的约束，即 $s_{\text{min}} \leq s_i \leq s_{\text{max}}$。

关节位置极限通过形式为 $q_{j,\text{min}} \leq q_j \leq q_{j,\text{max}}$ 的约束来尊重。关节速度极限也被引入，但更倾向于作为扭矩依赖的约束进行建模，这可以更准确地描述典型执行器的行为，请见III-G节。

此外，它是必要的来强制执行倾斜角界限 $\theta_{\text{min}} \leq \theta \leq \theta_{\text{max}}$ 以保持系统在一个直立平衡配置中。我们注意到在没有这些界限的情况下，阶段之间的连续配置可能导致倾斜角改变 $2\pi$，包含倾斜角变化的轨迹。

最后，我们经验了快速动态运动，如跳跃（见III-H节），可能需要强制执行精细的界限约束，以便更好地控制动作，而不仅仅是通过插入点来完成。

### F. 阶段转换

在阶段转换时，坐标 $q_s$ 必须保持连续，即 $q_{s, i+1}[1] = q_{s, i}[N_{k_i}]$。从II-D节的讨论中，速度 $\dot{q}_s$ 可能是不连续的，但必须满足条件：

$$\dot{q}_ {s, i+1}[1] = f_a(s_{i}[N_ {k_ i}], N \dot{q}_ {s, i}[N_ {k_ i}]).$$

这两个约束可以合并为：

$$
x_{s,i+1}[1] = h_i(x_{s,i}[N_{k,i}]) = \begin{bmatrix}
q_{s,i}[N_{k,i}] \\
f_{q_s}(s_i[N_{k,i}], N Q_{q_s,i}[N_{k,i}])
\end{bmatrix}.
$$

我们发现在转换时通过约束 $U_{i}[N_{k_i}] = U_{i+1}[1]$ 强制执行扭矩连续性也很有用，以防止扭矩跳变引起的不希望的高加速度。然而，这些约束并非绝对必要，因为电流控制执行器的动态通常非常快，比机械系统要快得多。

### G. 执行器限制

我们通过以下约束来考虑执行器扭矩的限制：

$$ -U_{\text{max}} \leq U_i \leq U_{\text{max}}, $$

并将执行器速度限制视为扭矩依赖——正如第73条建议的那样。近似执行器最大转速和扭矩之间的线性仿射关系通常应足够。公式（6）必须被用来保证足够的速度和扭矩。提出的约束形式为：

$$ -v_{\text{max}} + C \tau[k] \leq gs_{i,s}(x_{s}) \leq v_{\text{max}} - C \tau[k], $$

其中 $C$ 是某个常数对角矩阵， $v_{\text{max}}$ 是向量，而 $gs_{i,s}(x_{s}) = \left[ \left| \frac{m'(s)}{\|m'(s)\|} s \right| + \theta \right] \cdot [\dot{q}_1 \ldots \dot{q}_N]^T$。

对于整个阶段，执行器速度约束可能被收集（轻微滥用符号）为：

$$ -gT(U_i) \leq gs_{i,s}(X_i) \leq gT(U_i). $$

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/d14a4d9869a14adca75304bedb4a7faa.png)

### H. 跳跃动作的扩展

将所提议的TO方案扩展到处理飞行阶段是直接的，即在这些阶段系统没有与地面接触。在这些阶段应用状态向量 $z$ 替代 $x_s$，即：

$$ X_{i, \text{flight}} = \left[q_{f,i}[1] \ldots q_{f,i}[N_{k_i}]\right]. $$

相应的，动力学方程（2），以及在III-C节介绍的配置点方案中的 $\lambda_C$ 设置为零，用于直接控制跳跃路径参数化在 $q_f$ 上，使其可能直接指定笛卡尔空间的约束，如最小跳跃高度的约束等。

在相邻的飞行阶段之间，状态保持连续，并且过渡条件变为：

$$x_{f,i+1}[1] =x_{f,i}[N_{k_i}]$$

在起飞期间，即从接触阶段过渡到飞行阶段时，我们同样有状态的连续性：

$$x_{f,j+1}[1] = \begin{bmatrix}
f_{qf}(q_s[N_{k,j}]) \\
Q_{f q_s,i}[N_{k,j}]
\end{bmatrix}.$$

值得注意的是，由于动态系统对 $\phi$ 的不变性，对 $\phi$ 的约束可以省略，参见II-B节。在着陆过程中发生冲击性转换，转换条件因此变为：

$$ \begin{bmatrix}
f_{qf}(q_{s,i+1}[1]) \\
q_{s,i+1}[1]
\end{bmatrix} = 
\begin{bmatrix}
q_{f,i}[N_{k,j}] \\
f_{q_s}(N q_{f,i}[N_{k,j}])
\end{bmatrix}.$$

总结，我们注意到没有约束强制要求起飞和着陆发生在段落边界，从而为优化提供了选择最佳过渡位置的自由度。所需的只是增加一个具有上述参数化的阶段。

## IV. 应用于Ascento机器人

在本节中，我们讨论将提出的TO方案应用于Ascento——一个有四个动力执行器的双脚轮式平衡机器人。对于每条腿，一个驱动器驱动轮子，另一个驱动膝部，而且膝部还由一个弹簧支持。腿部设计是对称的，且其连杆仅允许在与对称平面平行的平面内运动，这使得采用II-B节的平面建模成为一个合理的选择。读者不应该被仅有五个自由度的平面模型所迷惑——一些相当复杂的复杂性隐藏在封闭的四连杆机构中。我们可以在不采用粗糙简化的情况下对其建模，这展示了我们方法的优势之一。

#### A. 机器人模型

我们以运动学一致的方式对四连杆进行建模。这与我们以前的工作 [17] 形成对比，后者采用了动力学方法。读者可以参考之前的作品来获取关于动力学的详细信息。我们还指出，本文中的建模方法也用于我们最近发表的关于Ascento的四连杆研究 [74]。然而，该衍生的结果和最终的方程并没有在那里展示。

按照II-B节后续内容的描述，我们选择以车轮为中心的参数化集来定义广义坐标 $$q_f = \begin{bmatrix} x & z & \varphi & \theta & \kappa \end{bmatrix}^T$$，其中 $\kappa$ 是车轮的膝盖角。此外，我们为车轮和膝部直接的作用提供了一种参数化四连杆机构的方式，但这导致简化的结果。执行向量由 $\tau = [T_ w \quad T_ k]^T$ 给出，其中 $T_w$ 和 $T_k$ 分别表示车轮和膝部的扭矩。接下来，我们将循环打开以参数化打开的连杆机构，定义增广状态：

$$ q_a = [x \quad \psi \quad \theta \quad \kappa \quad \alpha \quad \beta]^T, $$

其中 $\alpha$ 和 $\beta$ 是辅助变量（其他选择可能），见图 6。然后，通过应用选择的形式主义，可以导出增广系统的动力学方程 (EOM) 形式：

$$ 
M_a(q_a) \ddot{q}_a - h_a(q_a, \dot{q}_a) = S_a^T \tau + J_L^T \lambda_L, 
$$

其中 $J_L$ 表示循环的接触雅可比， $\lambda_L \in \mathbb{R}^2$ 是保持循环闭合所需的力。通过将 EOM 投影到一致约束的子空间，可以继续发展。辅助状态 $\alpha$ 和 $\beta$ 必须通过余弦规则的反复应用来表达，找到：

$$ \alpha(\kappa) = \alpha_1(\kappa) + \alpha_2(\kappa), $$

$$ \beta(\kappa) = \arccos \left(\frac{a^2 + b^2 - e^2(\kappa)}{2ab}\right), $$

其中，

$$ \gamma(\kappa) = \pi - \kappa - \epsilon, $$

$$ e(\kappa) = \sqrt{c^2 + d^2 - 2cd \cos(\gamma(\kappa))}, $$

$$ \alpha_1(\kappa) = \arccos \left(\frac{d^2 + e^2(\kappa) - c^2}{2de(\kappa)}\right), $$

$$ \alpha_2(\kappa) = \arccos \left(\frac{a^2 + e^2(\kappa) - b^2}{2ae(\kappa)}\right). $$

可以证明 $\alpha(\kappa)$ 和 $\beta(\kappa)$ 的函数是平滑可微的。从这些关系中可以直接推导出差分关系 $q_a = Q_a \dot{q}_f$ 和导数 $\dot{Q}_a$ 所需的约束一致 EOM 形式：

$$ M_f \dot{q}_f - h_f = S_f^T \tau, $$

其中 $M_f = Q^T M_a Q_f$, $S_f^T = Q^T S_a^T$, $h_f = Q^T (h_a - M_a Q_a \dot{q}_f)$。请注意，根据虚功原理， $Q^T J_L \lambda_L = 0$，即循环闭合力消失，因为运动学是一致的。

从这点开始，建模与II-B节相同。最小坐标集由 $q_s = [s \quad \theta \quad \kappa]^T$ 给出。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/afb1ccbb69344df0aebf712a0e58fd87.png)

### B. 跟踪控制

我们提出一种高增益比例-导数 (PD) 控制器，用于跟踪2D轨迹并稳定整个3D系统，同时使其动态在一个区域内被平面建模很好地近似。整体控制器的形式如下所述，并采用如下形式：

$$
\begin{bmatrix}
T_{w_l} - T_{w_r} \\
T_{k_l} - T_{k_r} \\
T_{w_l} + T_{w_r} \\
T_{k_l} + T_{k_r} \\
0
\end{bmatrix} = 
\begin{bmatrix}
K_{p,\psi}( \psi^* - \psi) + K_{d,\psi}(\dot{\psi}^* - \dot{\psi}) \\
K_{p,\phi}(\phi^* - \phi) + K_{d,\phi}(\dot{\phi}^* - \dot{\phi}) \\
K_{p,x}(x^* - x) + K_{d,x}(\dot{x}^* - \dot{x}) \\
K_{p,z}(z^* - z) + K_{d,z}(\dot{z}^* - \dot{z}) \\
0
\end{bmatrix} +
\begin{bmatrix}
\tilde{T}_ w + K_{p,\psi}(\psi^* - \psi) + K_{d,\psi}(\dot{\psi}^* - \dot{\psi}) \\
\tilde{T}_ k + K_{p,\phi}(\phi^* - \phi) + K_{d,\phi}(\dot{\phi}^* - \dot{\phi}) \\
\end{bmatrix},
$$

其中下标 $l$ 和 $r$ 分别表示左右两侧的量，上标 $*$ 表示期望的（区别于当前/测量的）量，而 $\tilde{\psi} = \frac{1}{2}(\psi_l + \psi_r)$ 和 $\tilde{\kappa} = \frac{1}{2}(\kappa_l + \kappa_r)$ 分别代表平均的车轮和膝角。此外， $\psi$、 $\phi$ 和 $x$ 分别代表机器人的偏航、滚动和俯仰角度。作为解决方案的前馈扭矩 $\tilde{T}_w$、 $\tilde{T}_k$ 被选为对应于当前时刻 TO 解的节点。

为了符合TO中的平面建模，所需的偏航角和平均膝角被设置以确定期望的俯仰角和期望的平均膝角，通过关系：

$$ \theta^* = \theta + \tilde{\kappa} - \alpha(\tilde{\kappa}). $$

该关系的时间微分给出 $\dot{\theta}^*$。

增益 $K_{p,\psi}$、 $K_{d,\psi}$、 $K_{p,x}$ 和 $K_{d,x}$ 由从长期经验中选择的参数决定，这些参数主要用于平衡动态。观察系统作为一个倒立摆动系统，膝角的变化可能有些间接，因为它们与摆动长度的变化相关，系统的惯性变化可能需要几个原因进行解释，并且我们假设这些变化在LQR中是固定的，即排除了它的动力学。在LQR中计算的输出是基于如下步骤获得的：首先，平面模型（12）被线性化并用于当前时间实例的TO。我们注意到与围绕平均状态的线性化相比，这种方法不需要估计 $s$，这带来了优势。然后，关系（6），（9）和（23）被用于将线性化模型从一个参数形式转换为另一个，影响到车轮角 $\psi$ 和底座倾斜角 $\chi$。因此，LQR中涉及的转换相关于从 $\begin{bmatrix} \psi \\ \chi \end{bmatrix}$ 到 $\begin{bmatrix} \dot{\psi} \\ \dot{\chi} \end{bmatrix}$ 的映射。在飞行阶段，与平衡无关的控制器部分不再有效。

在TO生成的模型中，建议的控制器也可用于调节系统朝向一个稳态参考。给定一个期望的设定点，模型（12）可以通过非线性求根找到来解决问题，并由此替代由TO假定的量。我们将前面假定的量替换为LQR中的权重。尽管如此，获得的增益和LQR权重相对直观简单，因为在正常运作模式下，这是相当直接的。作为一项实际措施，我们发现对不同机器人高度重要的是进行实验来验证整个膝角操作范围内的参数。

总结，我们希望强调还有更多复杂的跟踪控制器可以被合成，明确考虑计划和执行之间的时间差异。尽管这类控制器的开发还处于活跃研究领域 [75, 76]，并且尚未得到实际评估，尤其是在我们的情况下如何表现还不清楚。事实上，我们的评估表明，在TO中进行反馈消除了需要更复杂的跟踪控制器的需求。在这方面，我们也注意到与我们之前的分层全身控制器相比，此方法更为简洁，尽管它来自处理未建模的粗糙地形的经验 [17]。尽管如此，当追踪一个简单的步行路径时，本工作中提出的控制器导致了更优越的鲁棒性，提供了比在干扰模型中更直接的控制器优势。我们将此归因于接触估计质量不足,而前一种方法需要较高的接触估计质量才能完全发挥作用。

### C. 关于状态估计和系统识别的评注
任何基于模型的控制方案的性能都取决于状态估计和系统识别的质量,在包含实际试验的工作中,因此至少应该涉及这一点。因此,我们在下文中就这些主题提供了一些评注。
在第V节中展示的实际试验中采用的状态估计是纯粹的本体感知式的。机器人基座的线性和角速度由其惯性测量单元(IMU)的扩展卡尔曼滤波器(EKF)估计。关节角度由加速度级别的个别卡尔曼滤波器估计,即 $q_i[k]$ 。作为先验,使用了完整的平面动力学模型。也就是说,对于单个关节角度 $q_i$ ,我们为卡尔曼滤波器选择模型为

$$\begin{align*}
\begin{bmatrix}
q[k+1] \\
\dot{q}[k+1] \\
\ddot{q}[k+1]
\end{bmatrix} &= 
\begin{bmatrix}
1 & \Delta t & \frac{\Delta t^2}{2} \\
0 & 1 & \Delta t \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
q[k] \\
\dot{q}[k] \\
\ddot{q}[k]
\end{bmatrix} +
\begin{bmatrix}
0 \\
0 \\
f_{q_a}(x[k], u[k])
\end{bmatrix}, \\
q_{\text{meas}}[k] &= 
\begin{bmatrix}
1 & 0 & 0
\end{bmatrix}
\begin{bmatrix}
q[k] \\
\dot{q}[k] \\
\ddot{q}[k]
\end{bmatrix}^T,
\end{align*}
$$

其中 $q_{meas,i}[k]$ 表示由绝对电机编码器测量的关节角度。与平滑性相似的(加权)移动平均差分方案相比——比如说,在估计和跟踪控制环路中使用第十阶滤波器,运行于400Hz——卡尔曼滤波器在估计的关节速度上引入了20毫秒更短的延迟。我们发现这一减小是非常重要的,因为它允许在跟踪控制器中使用更加激进的增益。
为了识别惯性参数,我们在装配过程中精心称重了各个部件,并且在很大程度上依赖于系统的计算机辅助设计(CAD)模型。特别是,我们在建模中还考虑了电机定子的惯性。尽管如此,我们发现系统表现出不可忽略的稳态跟踪误差。例如,当被命令保持静止平衡时,它会从预期位置偏移达半米(直至达到允许其保持静止的倾斜角偏移)。我们将这一效应主要归因于基座质心(COM)位置的不确定性。它包含了大量电气元件,这些元件的惯性参数只能被大致确定。事实上,一种非线性最小二乘估计表明,COM位置与假设的位置略有不同(大约3厘米)。考虑到这一偏移,我们显著减小了稳态跟踪误差——对于上述例子,误差降低到了几厘米水平。

在所有版本的Ascento机器人中，膝关节电机由一个定制的、优化的弹簧系统支撑，该系统的作用是大致补偿机器人的重量，从而减少功耗。我们建模了通过系统产生的扭矩来近似补偿机器人的重量并因此减少功耗。我们通过一个光滑可微的线性-二次模型来描述这一扭矩：

$$
\tau_s(k) = k_1 (k - k_0) + k_2 (k - k_0)^2,
$$

我们通过非线性最小二乘法拟合了参数 $k_0$、 $k_1$、 $k_2$。

我们的前两个原型的机械设计被发现存在严重的方向依赖性摩擦，尤其是在轮子和膝关节，这显著地恶化了追踪效果。我们通过基于扭矩输出的简单函数近似摩擦并相应地调节追踪控制器的输出来缓解这一效应，减少了影响到一个或多或少可以接受的程度。但我们没有完全解决问题——最后，提高悬挂系统的机械设计效果非常显著。减少关节轴的摩擦量到几乎不再是问题。

最终，我们发现，放气轮胎——这在行进中的其他应用中常见，比如当必须通过楼梯时——极大地帮助了轨迹追踪。我们将此归因于两个效果。首先，增加的阻尼减少了反弹，这是我们的模型中未建模的——例如，当轮子与台阶的边缘接触时。我们注意到，我们预先设定的相位排序实际上等于假设系数相位是要被补充的。其次，放气的轮胎有助于抓地，例如在轮胎需要抵抗滑落的台阶边缘时。仔细观察发现，最终的抓地能力可以在静摩擦系数看起来比1还要高的情况下表现出来。因此，我们发现通常使用的选择 $\mu = 0.8$ 被提高到了 $\mu = 1.0$。

### V. 结果与讨论

在本节中，我们讨论了我们的 TO 方案的实施，通过模拟测试其性能，并调查其在现实世界实验中的潜在有效性。我们建议读者观看本文中所展示的所有动作，以及其他一些动作。

#### A. 优化设置

我们的实施方案中有几个方面需要注意，包括我们的硬件选择，测试布局和最终的跟踪方法。我们将在下面描述它们。

1) **问题规范**：我们通过其 MATLAB 接口使用 CasADi 实施了我们的 TO 方案，这在很大程度上依赖于 CasADi 的自动微分功能——我们主要使用它来导出动态方程。我们发现 CasADi 的图形优化能显著改善从代数表达式中得出的计算时间。为了专门处理编程语言独立的优化问题，我们使用了 CasADi 的 Opti 框架，它允许导出问题编程语言独立。我们注意到启用 CasADi 的编译选项减少了运算时间——尽管有一次性编译时间成本，编译持续时间为几分钟。

    对于 2D 地形建模，我们选择了函数 $c_i(x)$ 来描述地形，这允许优化问题保持平滑，这在使用基于梯度的求解器时是可取的。

2) **求解器**：为了解决所提出的非线性规划（NLP）问题，我们评估了几个最先进的 NLP 求解器。我们注意到进行定性甚至定量比较，包括每个求解器的设置调整和使用可比实例的成本是必要的。成功率和收敛速度按降序排列：
    - **IPOPT**：所有测试案例都成功收敛。作为线性求解器，我们使用了 HSL 的 MA97 程序，这使得求解速度提高了两倍。在默认的 IPOPT 设置下，对于每个阶段的 20 个离散化区间和轨迹生成，特别是对于简单地形（跨三个阶段），求解时间仅为 0.3 秒。对于具有 4 - 8 个阶段的更复杂地形，求解时间在 2 - 4 秒之间。对于有超过 20 个阶段的楼梯设置，大约需要 15 秒。通过调整求解器的设置，我们可以进一步减半解决方案时间——特别是使用 Hessian 近似选项被证明是有益的，尽管 Hessian 计算是优化中最昂贵的部分。
    - **SNOPT**：所有测试案例均实现了收敛。该求解器对于较小的问题比 **IPOPT** 的时间更短，但对于较大的问题则更慢。
    - **WORHP**：所有测试案例均实现了收敛。该求解器的时间通常比 **IPOPT** 慢约 50%。
    - **结构利用 SQP（"Scgpen"）**：仅在测试短期案例时实现收敛。该求解器通常比 **WORHP** 慢。
    - **基础 SQP（"Sqpmethod"）**：没有一个测试案例实现收敛。

总的来说，我们最满意 **IPOPT**，因此将其作为我们的主要求解器。

3) **初始化求解过程**：为了初始化原始变量，我们采用了一种简单的程序，即在线性插值优化的初始和终止位置状态之间进行。在此过程中，各个阶段的持续时间被选择为与它们的弧长成比例。对于每个阶段，我们随后将弧线速度的初始猜测设置为该阶段的弧长除以相应阶段持续时间的初始猜测值。此外，我们将膝关节扭矩初始化为其稳态值。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/16a95439313242a1aa357ea44471998f.png)

#### B. 轨迹解决方案的示例
为了评估TO方案的多功能性，我们在50多种不同的地形上生成了轨迹，包括台阶、楼梯、坡道、沟渠、半管、凸起物及其组合。只有在地形本身不允许物理解决方案的情况下，例如由于执行跳跃动作时高度超过1.2米的执行器限制，才似乎无法返回解决方案。图7展示了三个在复杂地形上的示例轨迹。

我们在图8中详细展示了克服两个倾斜台阶的解决方案。该轨迹包括总共五个接触阶段，其中有两个冲击性和两个平滑过渡。状态、输入和接触力约束在所有时间点都得到满足。当接触台阶的边缘时，牵引比率达到最大值。我们注意到在那些时间点，弧长参数、倾斜度、膝关节和轮速度的冲击。

如第三部分-E节所述，只需通过将俯仰角的期望终端值增加2π，就可以让机器人在跳过地形间隙时执行后空翻，见图9。

#### C. 稳健性评估
为了洞察我们的轨迹优化器在与第IV-B节提出的跟踪控制器结合使用时的稳健性，我们在模拟中进行了多项测试。具体来说，我们评估了针对各种不利影响的性能：撞击干扰、过程噪声、执行噪声、建模错误、测量噪声、测量延迟、执行延迟和地形不匹配。其中，执行延迟被证明具有最不利的影响。然而，与大多数其他不利影响类似，我们没有观察到它在实际系统上引起关注。因空间原因，我们因此没有呈现相应的评估，而是专注于实际上最重要的地形不匹配情况。了解其影响不仅因为地形的几何形状和相对机器人位置难以准确感知而重要，而且因为我们发现高估台阶高度是有益的，正如下一节所述。

为此，我们在轨迹生成后修改了一个10厘米台阶的高度和位置。图10显示了在变化的地形上执行轨迹得到的稳健性地图。结果表明，高估台阶高度并不构成太大问题，尽管不希望发生起飞。这尤其是在台阶距离同时被低估时发生，因为这会导致腿部过早收缩。这些发现与实际系统上的实验结果非常吻合，并解释了在TO中高估台阶高度的稳健性好处。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/4d8ca2453bc14db7b9f9a3090b9666b2.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/4ce48be0a0ec40b58ecb23975a9ab381.png)


#### D. 现实世界实验验证
我们通过展示在最新的两个Ascento原型上进行的几项实际实验来结束这一节。
1) **实验设置**：两个原型在设计上相似，使用相同的电机。较新的原型具有更为坚固的机械设计，代价是重量增加了18%。此外，它采用了完全重新设计的弹簧机制，其中省略了扭转弹簧[84]。由于基于模型的方法，切换原型只需要更改惯性参数并执行第IV-C节中描述的识别程序。
   跟踪控制器和状态估计器在ROS[85]中用C++实现，使用Eigen[86]，轨迹通过C++ CasADi接口提供：轨迹可以在一个单独的线程中计算，或者为特定情况预先计算并加载。这允许跟踪控制器维持400 Hz的恒定频率。为了解决跟踪控制器中使用的离散时间代数Ricatti方程（DARE），我们使用[87]中的强健迭代求解器，并以前一次迭代的Ricatti矩阵为初值。这导致解决时间少于0.25毫秒，远非控制环路所需的400 Hz的临界值。
   
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/c2f9fc3e248543d9a45482ee084f6d91.png)

2) **轨迹跟踪实验**：以下是选定的轨迹跟踪实验展示，其中大部分在图11中显示。在更复杂的地形上执行轨迹似乎主要受到本体感觉状态估计的限制，这阻碍了随时间准确估计机器人相对于地形的位置。
   - **单一台阶**：高达20厘米的台阶——接近25厘米的轮径——可以可靠地克服。图11显示了10厘米和20厘米台阶的案例。我们还测试了初始距离（在轨迹优化中考虑）如何影响可靠性。鉴于本体感觉设置，这不是很令人惊讶，发现最可靠的执行轨迹是从轮子接触台阶开始（但允许向后驾驶以加速，见脚注6）。这确保了机器人相对于地形的位置最初被精确地知晓。此外，台阶是我们调整参数以提高稳健性的唯一地形类型。即，在TO中高估台阶高度20-50%（更高的值会导致不希望的起飞）导致接近100%的成功率。我们将这种补偿的需要归因于轮胎形变导致的能量耗散。
   - **站立**：Ascento能够通过坐在弯曲的膝盖上来节省能量，并处于休息状态。然而，再次起立并非易事。我们的TO使我们能够找到从这一位置返回到平衡状态的轨迹。它在第一次尝试中就成功了，并且可以重复执行而不发生单一失败。
   - **跳跃**：为验证跟踪包含飞行阶段的轨迹的能力，我们在原地执行了希望地面间隙为5厘米的跳跃。测试了两种情况：将扭矩限制设定为40 Nm和30 Nm。两者都可以反复执行而不失败，后者显示了通过利用系统的腿部动力学更多地使用动量。
   - **两个台阶**：图12显示了在连续攀登两个10厘米台阶的轨迹执行过程中跟踪的轮子、膝盖和俯仰角。我们注意到，通过没有轮滑的迹象表明满足了牵引极限。
3) **楼梯攀登**：当前的本体感觉状态估计，跟踪单一轨迹通过完整楼梯可能由于时间推移对地形的不准确定位而失败。然而，通过连续执行单一台阶轨迹，每当碰到下一个台阶时触发，可以实现穿越具有任意数量台阶的楼梯。为确保确实建立并维持与台阶的接触，直到开始跟踪下一条轨迹，我们叠加了0.3 m/s的小前向速度。这具有使机器人自对准和减轻回滚到前一个台阶的风险的额外优点。有了这种设置，我们能够攀登像图1中显示的那样的楼梯。我们注意到，鉴于台阶宽度为29厘米和轮径为25厘米，用于重新平衡和加速的空间很小。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/80190cbb14cc414d903fafccd3536a70.png)


4) **没有TO的跟踪控制**：跟踪控制器本身证明在稳定机器人和防止其失去平衡方面极为有能。通过在高度非结构化的地形上行驶，如森林地面，控制参考由用户通过遥控而不是TO提供——见随附视频。此外，单独的跟踪控制器足以可靠地驾驶下楼梯（但不是上楼梯），这也在视频中显示。总的来说，我们从未经历过跟踪轨迹失败导致机器人翻车的情况。
这些实验与前一小节的稳健性评估结合，允许就精确地形测绘和定位的重要性提出一些看法。首先，稳健性评估表明，无需完美知晓地形的尺寸或机器人的相对位置。特别是，通过向TO提供适当偏移的尺寸，可以获得方便的安全边际。其次，最后一个实验表明，地形测绘中的某种程度的平滑和分辨率不足可以得到补偿。第三，跟踪控制器防止失衡的有效性进一步减少了精确感知的必要性，因为在未能通过障碍物后，机器人可能简单地再次尝试。接下来的展望补充了这些考虑，并提出了可能有助于在现实世界应用中成功自主部署的扩展。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/1a71ef1845d14e0aa36cfd548eb928a1.png)


## VI. 结论与展望
在本研究中，我们提出了一个针对轮式平衡机器人在各种挑战性地形上运动的轨迹优化器。所呈现的方案能够处理接触切换和冲击，并生成利用完整的2D刚体动力学的非平滑轨迹，同时遵守明确的牵引力和输入约束。我们将这一方法应用于Ascento机器人，并在此示例中提供了其动力学方程的新的封闭形式解。

我们的仿真结果不仅确认了我们方法的多功能性，而且还表明，在存在适度不确定性和模型失配的情况下，优化的轨迹适合应用。事实上，最新的Ascento原型机的实验表明，可以成功执行跳跃、站立和克服台阶等轨迹。最重要的是，通过顺序触发单个台阶轨迹的执行，使得能够爬上标准楼梯。

作为展望，我们列出了一些可能构成研究有前景方向的扩展：
- **时变跟踪LQR**：一些初步测试表明，轨迹过程中变化的反馈律可能进一步提高稳健性和跟踪性能。不幸的是，这种增益调度方法因需求极高的执行器带宽而臭名昭著。然而，[35]提出的频率感知成本整形可能缓解这个问题。
- **重新规划**：以衰减视野方式应用TO可能显著提高稳健性和跨越长、复杂地形段的能力。预热启动预计可以大幅降低平均计算时间，因为原始变量和对偶变量本质上应该在时间上进行移动。这可以与使用离线运动库的方法结合，如[7]所提出的。此外，可以引入一个更快的重新规划循环——可能采用更短的视野和简化的模型——目标频率为20 - 30 Hz（具体数字见[31]、[35]、[88]）。接触计划可以从高保真、长视野TO中继承，类似于[7]、[47]。
- **扩展到3D**：有几种方式可以尝试处理3D地形。例如对于Ascento，一个直接的方法——可能已覆盖大多数用例——是假设滚动和偏航运动作为弧参数的函数，例如由高级规划器给出。本质上，建模仍然是平面的，但发生在曲面2D表面上。关于单独的车轮可能遇到不同地形的可能性，我们注意到根据我们的经验，这仅在差异显著时才是一个障碍。小差异的影响可由跟踪控制器很好地补偿，而大的差异很可能经常被专用规划器规避。
- **基于事件的状态估计**：为了克服当前本体感觉设置的限制，无需更复杂的传感系统，可以利用冲击事件发生时获得的信息。以撞击台阶边缘为例，这些可以作为状态估计的先验，以定位机器人相对于地形的位置。这可能使执行更长轨迹成为可能，并使系统更接近自主操作的一大步。

### 附录

#### A. 运动学一致的配置方案

在下文中，我们将提供扩展的Hermite-Simpson配置方案的推导，该方案在第III-C节中提出。我们的起点是一个三阶多项式向量 $p_q$，用来插值广义速度 $\dot{q}$ 在时间间隔 $\Delta t$ 上。给定它的 Hermite 形式表示，即通过系数 $q_A = p_q(0)$， $q_B = p_q(\Delta t)$，我们得到：

$$
p_{\dot{q}}(t) = \left( \frac{1}{2} (q_A + q_B) - \frac{3}{2 \Delta t} (q_B - q_A) \right) t^3 + \left( \frac{3}{2} (q_B - q_A) - \frac{1}{2} (q_A + q_B) \right) t^2 + \dot{q}_A t + q_A.
$$

在中点 $\frac{\Delta t}{2}$ 处的求值得到 (16) 和 (17):

$$
\dot{q}_ C = p_{\dot{q}}\left(\frac{\Delta t}{2}\right) = \frac{5}{8} (q_A + q_B) + \frac{\Delta t}{8} (\dot{q}_A - \dot{q}_B), 
$$

$$
\dot{q}_ C = p_{\dot{q}}\left(\frac{\Delta t}{2}\right) = -\frac{2}{3 \Delta t} (q_A - q_B) - \frac{1}{8} (\dot{q}_A + \dot{q}_B). 
$$

我们注意到这些是应用于 $\dot{q}$ 的标准中点公式的三次 Hermite-Simpson 配置方案。

为了在区间 $[0, \Delta t]$ 内插值广义坐标 $q$，运动学与多项式近似 $\dot{q}$ 一致，我们定义 $p_q$ 作为 $p_{\dot{q}}$ 的积分，即：

$$
p_q(t) = \int_0^t p_{\dot{q}}(\tau) d\tau
$$

$$
= \left( \frac{1}{4 \Delta t^2} (q_A + q_B) - \frac{1}{2 \Delta t^3} (q_B - q_A) \right) t^4 + \left( \frac{1}{2 \Delta t} (q_B - q_A) - \frac{1}{6 \Delta t^2} (q_A + q_B) \right) t^3 + \frac{1}{2} \dot{q}_A t^2 + q_A t + q_A. 
$$

在中点 $\frac{\Delta t}{2}$ 处的求值给出 (15):

$$
q_C = p_q\left(\frac{\Delta t}{2}\right) = \frac{\Delta t}{32} (13 q_A + 3 q_B) + \frac{\Delta t^2}{192} (11 \dot{q}_A - 5 \dot{q}_B) + q_A. 
$$

正如在标准三次 Hermite-Simpson 方案中，动力学在中点需要满足，这给出了（差分）配置约束 (18):

$$
\dot{q}_C = f_q(q_C, \dot{q}_C, \tau_C),
$$

其中 $\tau_C = \frac{1}{2} (T_A + T_B)$， $T_A = \tau(0)$ 和 $T_B = \tau(\Delta t)$。正如我们已经注意到的，依赖于 $q_B$ 在 (27) 中必须通过在 $\Delta t$ 处匹配 $q_B$ 的附加约束来建立，这给出了（积分）配置约束 (19):

$$
q_B = p_q(\Delta t) = \frac{\Delta t}{2} (\dot{q}_A - \dot{q}_B) + q_A.
$$

这完成了推导。

